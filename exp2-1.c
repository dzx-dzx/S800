
#include <stdint.h>
#include <stdbool.h>
#include <stdio.h>
#include "hw_memmap.h"
#include "debug.h"
#include "gpio.h"
#include "hw_i2c.h"
#include "hw_types.h"
#include "i2c.h"
#include "pin_map.h"
#include "sysctl.h"
#include "driverlib/interrupt.h"
#include "inc/tm4c1294ncpdt.h"
#include "interrupt.h"
#include "systick.h"
#include "uart.h"
#include "string.h"
#include "qei.h"
#include "pwm.h"
#include "eeprom.h"

//*****************************************************************************
//
//I2C GPIO chip address and resigster define
//
//*****************************************************************************
#define TCA6424_I2CADDR 0x22
#define PCA9557_I2CADDR 0x18

#define PCA9557_INPUT 0x00
#define PCA9557_OUTPUT 0x01
#define PCA9557_POLINVERT 0x02
#define PCA9557_CONFIG 0x03

#define TCA6424_CONFIG_PORT0 0x0c
#define TCA6424_CONFIG_PORT1 0x0d
#define TCA6424_CONFIG_PORT2 0x0e

#define TCA6424_INPUT_PORT0 0x00
#define TCA6424_INPUT_PORT1 0x01
#define TCA6424_INPUT_PORT2 0x02

#define TCA6424_OUTPUT_PORT0 0x04
#define TCA6424_OUTPUT_PORT1 0x05
#define TCA6424_OUTPUT_PORT2 0x06

#define SYSTICK_FREQUENCY 1000

#define MASTER_MODE_CALENDER 0
#define MASTER_MODE_SOLAR_TERMS 1
#define MASTER_MODE_TIME 2
#define MASTER_MODE_COUNTDOWN 3
#define MASTER_MODE_ALARM 4
#define MASTER_MODE_BOOT 5
#define NUMBER_OF_MASTER_MODES 5 //排除启动模式.
#define TIME_MODE_DISPLAY 0
#define TIME_MODE_SET 1
#define CALENDER_MODE_DISPLAY 0
#define CALENDER_MODE_SET 1
#define COUNTDOWN_MODE_CLEAR 0
#define COUNTDOWN_MODE_FORWARD 1
#define COUNTDOWN_MODE_PAUSE 2
#define COUNTDOWN_MODE_TIMEOUT 3
#define COUNTDOWN_MODE_SET 4
#define ALARM_MODE_DISPLAY 0
#define ALARM_MODE_SET 1
#define ALARM_MODE_RINGING 2
#define NUMBER_OF_ALARMS 2

#define SECONDS_IN_TROPICAL_YEAR 31556925
#define NUMBERS_OF_LIGHT_LEVELS 5 //0 for off and NUMBERS_OF_LIGHT_LEVELS-1 for full.

void Delay(uint32_t value);
void UARTStringPut(const char *cMessage);

uint8_t I2C0_WriteByte(uint8_t DevAddr, uint8_t RegAddr, uint8_t WriteData);
uint8_t I2C0_ReadByte(uint8_t DevAddr, uint8_t RegAddr);

void S800_GPIO_Init(void);
void S800_I2C0_Init(void);
void S800_Int_Init(void);
void S800_UART_Init(void);
void S800_QEI_Init(void);
void S800_PWM_Init(void);

void flash_seg(uint8_t display_index, uint8_t control_word);
uint32_t ui32SysClock;

struct PeripheralDeviceInput
{
	uint8_t keyPadStateByte;
	uint8_t buttonStateByte;
	char UARTMessage[100];
	char *UARTMessageTail;
	uint16_t UARTMessageReceiveFinishedCountdown;
	int8_t QEIDirection;
	uint8_t QEIPosition;
} peripheralDeviceInput;

struct PeripheralDeviceOutput
{
	uint8_t segmentDisplayControlWord[8];
	uint8_t LEDDisplayByte;
	uint32_t beepFrequency; //Set to 0 to turn off.
	uint8_t lightLevel;
	uint8_t motorClockwise;
	uint8_t motorCycle;
} peripheralDeviceOutput;

struct Time
{
	uint16_t year;
	uint16_t month;
	uint16_t day;
	uint16_t hour;
	uint16_t minute;
	uint16_t second;
	uint16_t tenMillisecond;
};
const uint16_t daysInMonth[] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};
const uint16_t daysInMonthInLeapYear[] = {31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};
const uint16_t daysInYear = 365;
const uint16_t daysInLeapYear = 366;
const uint64_t solarTermsTimestampIn2021[] = {160978820500 + 8 * 3600 * 100, 161105999000 + 8 * 3600 * 100, 161233552700 + 8 * 3600 * 100, 161361623600 + 8 * 3600 * 100, 161490562000 + 8 * 3600 * 100, 161620424700 + 8 * 3600 * 100, 161751450600 + 8 * 3600 * 100, 161883560200 + 8 * 3600 * 100, 162016843000 + 8 * 3600 * 100, 162151062600 + 8 * 3600 * 100, 162286152500 + 8 * 3600 * 100, 162421752900 + 8 * 3600 * 100, 162557672800 + 8 * 3600 * 100, 162693518400 + 8 * 3600 * 100, 162829043700 + 8 * 3600 * 100, 162963929600 + 8 * 3600 * 100, 163097957500 + 8 * 3600 * 100, 163230966300 + 8 * 3600 * 100, 163362834100 + 8 * 3600 * 100, 163493586900 + 8 * 3600 * 100, 163623232600 + 8 * 3600 * 100, 163751962300 + 8 * 3600 * 100, 163879902300 + 8 * 3600 * 100, 164007355800 + 8 * 3600 * 100};

#define MAX_CHORD_SIZE 6

struct Note
{
	uint8_t chord[MAX_CHORD_SIZE];
	uint32_t time;
	uint8_t chordSize;
};
const struct Note notes[] = 
{{{75},0,1},{{0},338,1},{{73},375,1},{{0},712,1},{{80},750,1},{{0},1088,1},{{73},1125,1},{{0},1463,1},{{75},1500,1},{{0},1838,1},{{73},1875,1},{{0},2213,1},{{68},2250,1},{{0},2588,1},{{73},2625,1},{{0},2963,1},{{75},3000,1},{{0},3338,1},{{73},3375,1},{{0},3713,1},{{80},3750,1},{{0},4088,1},{{73},4125,1},{{0},4463,1},{{75},4500,1},{{0},4838,1},{{73},4875,1},{{0},5213,1},{{68},5250,1},{{0},5588,1},{{73},5625,1},{{0},5963,1},{{75},6000,1},{{0},6337,1},{{73},6375,1},{{0},6712,1},{{80},6750,1},{{0},7087,1},{{73},7125,1},{{0},7462,1},{{75},7500,1},{{0},7837,1},{{73},7875,1},{{0},8212,1},{{68},8250,1},{{0},8587,1},{{73},8625,1},{{0},8962,1},{{75},9000,1},{{0},9337,1},{{73},9375,1},{{0},9712,1},{{80},9750,1},{{0},10087,1},{{73},10125,1},{{0},10462,1},{{75},10500,1},{{0},10837,1},{{73},10875,1},{{0},11212,1},{{68},11250,1},{{0},11587,1},{{73},11625,1},{{0},11962,1},{{75},12000,1},{{0},12337,1},{{73},12375,1},{{0},12712,1},{{80},12750,1},{{0},13087,1},{{73},13125,1},{{0},13462,1},{{75},13500,1},{{0},13837,1},{{73},13875,1},{{0},14212,1},{{68},14250,1},{{0},14587,1},{{73},14625,1},{{0},14962,1},{{75},15000,1},{{0},15337,1},{{73},15375,1},{{0},15712,1},{{80},15750,1},{{0},16087,1},{{73},16125,1},{{0},16463,1},{{75},16500,1},{{0},16838,1},{{73},16875,1},{{0},17213,1},{{68},17250,1},{{0},17588,1},{{73},17625,1},{{0},17963,1},{{75},18000,1},{{0},18338,1},{{73},18375,1},{{0},18713,1},{{80},18750,1},{{0},19088,1},{{73},19125,1},{{0},19463,1},{{75},19500,1},{{0},19838,1},{{73},19875,1},{{0},20213,1},{{80},20250,1},{{0},20588,1},{{73},20625,1},{{0},20963,1},{{87,84,80,75,68},21000,5},{{0},22350,1},{{75},22500,1},{{0},22905,1},{{68},23250,1},{{0},23385,1},{{71},23400,1},{{0},23535,1},{{75},23550,1},{{0},23685,1},{{73,70,66},23700,3},{{0},24240,1},{{78,73,66},24300,3},{{0},24840,1},{{73},24900,1},{{0},25305,1},{{82},25350,1},{{0},25485,1},{{80},25500,1},{{0},25905,1},{{79},25950,1},{{0},26085,1},{{80},26100,1},{{0},26640,1},{{87},26700,1},{{0},27240,1},{{80},27300,1},{{0},27840,1},{{87,80},27900,2},{{0},28440,1},{{85},28500,1},{{0},28770,1},{{85},28800,1},{{0},28868,1},{{87},28875,1},{{0},28943,1},{{85},28950,1},{{0},29085,1},{{82},29100,1},{{0},29370,1},{{78},29400,1},{{0},29670,1},{{80},29700,1},{{0},31710,1},{{75},31800,1},{{0},32070,1},{{75,71,66},32100,3},{{0},32505,1},{{68},32850,1},{{0},32985,1},{{71},33000,1},{{0},33135,1},{{75},33150,1},{{0},33285,1},{{73,70,66},33300,3},{{0},33840,1},{{78,73,66},33900,3},{{0},34440,1},{{73},34500,1},{{0},34770,1},{{79,70},34800,2},{{0},35070,1},{{80},35100,1},{{0},35370,1},{{82},35400,1},{{0},35670,1},{{75},35700,1},{{0},35835,1},{{83},35850,1},{{0},35985,1},{{73},36000,1},{{0},36135,1},{{82},36150,1},{{0},36285,1},{{71},36300,1},{{0},36435,1},{{80},36450,1},{{0},36585,1},{{70},36600,1},{{0},36735,1},{{78},36750,1},{{0},36885,1},{{80},36900,1},{{0},37035,1},{{87},37050,1},{{0},37185,1},{{85},37200,1},{{0},37335,1},{{87},37350,1},{{0},37485,1},{{80},37500,1},{{0},37635,1},{{87},37650,1},{{0},37785,1},{{85},37800,1},{{0},37935,1},{{87},37950,1},{{0},38085,1},{{80},38100,1},{{0},38235,1},{{87},38250,1},{{0},38385,1},{{85},38400,1},{{0},38535,1},{{87},38550,1},{{0},38685,1},{{80},38700,1},{{0},38835,1},{{87},38850,1},{{0},38985,1},{{85},39000,1},{{0},39135,1},{{87},39150,1},{{0},39285,1},{{80},39300,1},{{0},39435,1},{{87},39450,1},{{0},39585,1},{{84},39600,1},{{0},39735,1},{{87},39750,1},{{0},39885,1},{{80},39900,1},{{0},40035,1},{{87},40050,1},{{0},40185,1},{{84},40200,1},{{0},40335,1},{{87},40350,1},{{0},40485,1},{{80},40500,1},{{0},40635,1},{{87},40650,1},{{0},40785,1},{{84},40800,1},{{0},40935,1},{{87},40950,1},{{0},41085,1},{{80},41100,1},{{0},41370,1},{{75},41400,1},{{0},41670,1},{{83},41700,1},{{0},41835,1},{{75},41850,1},{{0},41985,1},{{82},42000,1},{{0},42135,1},{{75},42150,1},{{0},42285,1},{{83},42300,1},{{0},42435,1},{{75},42450,1},{{0},42585,1},{{85},42600,1},{{0},42735,1},{{75},42750,1},{{0},42885,1},{{82},42900,1},{{0},43035,1},{{70},43050,1},{{0},43185,1},{{80},43200,1},{{0},43335,1},{{70},43350,1},{{0},43485,1},{{78},43500,1},{{0},43770,1},{{75},43800,1},{{0},43935,1},{{78},43950,1},{{0},44085,1},{{80},44100,1},{{0},44235,1},{{71},44250,1},{{0},44385,1},{{78},44400,1},{{0},44535,1},{{71},44550,1},{{0},44685,1},{{80},44700,1},{{0},44835,1},{{71},44850,1},{{0},44985,1},{{83},45000,1},{{0},45135,1},{{71},45150,1},{{0},45285,1},{{78},45300,1},{{0},45435,1},{{71},45450,1},{{0},45585,1},{{76},45600,1},{{0},45735,1},{{71},45750,1},{{0},45885,1},{{75},45900,1},{{0},46170,1},{{75},46200,1},{{0},46335,1},{{78},46350,1},{{0},46485,1},{{76},46500,1},{{0},46635,1},{{68},46650,1},{{0},46785,1},{{75},46800,1},{{0},46935,1},{{68},46950,1},{{0},47085,1},{{73},47100,1},{{0},47235,1},{{68},47250,1},{{0},47385,1},{{76},47400,1},{{0},47535,1},{{68},47550,1},{{0},47685,1},{{75},47700,1},{{0},47835,1},{{68},47850,1},{{0},47985,1},{{73},48000,1},{{0},48135,1},{{68},48150,1},{{0},48285,1},{{71},48300,1},{{0},48435,1},{{68},48450,1},{{0},48585,1},{{75},48600,1},{{0},48735,1},{{68},48750,1},{{0},48885,1},{{73},48900,1},{{0},49035,1},{{64},49050,1},{{0},49185,1},{{71},49200,1},{{0},49335,1},{{64},49350,1},{{0},49485,1},{{70},49500,1},{{0},49635,1},{{64},49650,1},{{0},49785,1},{{68},49800,1},{{0},49935,1},{{64},49950,1},{{0},50085,1},{{67},50100,1},{{0},50235,1},{{63},50250,1},{{0},50385,1},{{68},50400,1},{{0},50535,1},{{63},50550,1},{{0},50685,1},{{70},50700,1},{{0},50970,1},{{63},51000,1},{{0},51270,1},{{71},51300,1},{{0},51435,1},{{63},51450,1},{{0},51585,1},{{70},51600,1},{{0},51735,1},{{63},51750,1},{{0},51885,1},{{71},51900,1},{{0},52035,1},{{63},52050,1},{{0},52185,1},{{73},52200,1},{{0},52335,1},{{63},52350,1},{{0},52485,1},{{70},52500,1},{{0},52635,1},{{58},52650,1},{{0},52785,1},{{68},52800,1},{{0},52935,1},{{58},52950,1},{{0},53085,1},{{66},53100,1},{{0},53370,1},{{63},53400,1},{{0},53535,1},{{66},53550,1},{{0},53685,1},{{68},53700,1},{{0},53835,1},{{59},53850,1},{{0},53985,1},{{68},54000,1},{{0},54135,1},{{66},54150,1},{{0},54285,1},{{68},54300,1},{{0},54435,1},{{70},54450,1},{{0},54585,1},{{71},54600,1},{{0},54735,1},{{68},54750,1},{{0},54885,1},{{66},54900,1},{{0},55035,1},{{59},55050,1},{{0},55185,1},{{64},55200,1},{{0},55335,1},{{59},55350,1},{{0},55485,1},{{63},55500,1},{{0},55770,1},{{63},55800,1},{{0},55935,1},{{66},55950,1},{{0},56085,1},{{64},56100,1},{{0},56370,1},{{76},56400,1},{{0},56535,1},{{75},56550,1},{{0},56685,1},{{73},56700,1},{{0},56835,1},{{71},56850,1},{{0},56985,1},{{70},57000,1},{{0},57135,1},{{75},57300,1},{{0},57435,1},{{73},57450,1},{{0},57585,1},{{75},57600,1},{{0},57735,1},{{76},57750,1},{{0},57885,1},{{75},57900,1},{{0},58035,1},{{73},58050,1},{{0},58185,1},{{71},58200,1},{{0},58335,1},{{70},58350,1},{{0},58485,1},{{68},58500,1},{{0},58770,1},{{75},58800,1},{{0},59070,1},{{67},59100,1},{{0},59370,1},{{75},59400,1},{{0},59670,1},{{68},59700,1},{{0},60780,1},{{75,71,66},60900,3},{{0},61305,1},{{68},61650,1},{{0},61785,1},{{71},61800,1},{{0},61935,1},{{75},61950,1},{{0},62085,1},{{73,70,66},62100,3},{{0},62640,1},{{78,73,66},62700,3},{{0},63240,1},{{73},63300,1},{{0},63705,1},{{82},63750,1},{{0},63885,1},{{80},63900,1},{{0},64305,1},{{79},64350,1},{{0},64485,1},{{80},64500,1},{{0},65040,1},{{87},65100,1},{{0},65640,1},{{80},65700,1},{{0},66240,1},{{87,80},66300,2},{{0},66840,1},{{85},66900,1},{{0},67170,1},{{85},67200,1},{{0},67268,1},{{87},67275,1},{{0},67343,1},{{85},67350,1},{{0},67485,1},{{82},67500,1},{{0},67770,1},{{78},67800,1},{{0},68070,1},{{80},68100,1},{{0},70110,1},{{75},70200,1},{{0},70335,1},{{68},70350,1},{{0},70485,1},{{75,71,66},70500,3},{{0},70905,1},{{68},71250,1},{{0},71385,1},{{71},71400,1},{{0},71535,1},{{75},71550,1},{{0},71685,1},{{73,70,66},71700,3},{{0},72240,1},{{78,73,66},72300,3},{{0},72840,1},{{73},72900,1},{{0},73170,1},{{79},73200,1},{{0},73470,1},{{80},73500,1},{{0},73770,1},{{82},73800,1},{{0},74070,1},{{75},74100,1},{{0},74235,1},{{83},74250,1},{{0},74385,1},{{73},74400,1},{{0},74535,1},{{82},74550,1},{{0},74685,1},{{71},74700,1},{{0},74835,1},{{80},74850,1},{{0},74985,1},{{70},75000,1},{{0},75135,1},{{78},75150,1},{{0},75285,1},{{80},75300,1},{{0},75435,1},{{87},75450,1},{{0},75585,1},{{85},75600,1},{{0},75735,1},{{87},75750,1},{{0},75885,1},{{80},75900,1},{{0},76035,1},{{87},76050,1},{{0},76185,1},{{85},76200,1},{{0},76335,1},{{87},76350,1},{{0},76485,1},{{80},76500,1},{{0},76635,1},{{87},76650,1},{{0},76785,1},{{85},76800,1},{{0},76935,1},{{87},76950,1},{{0},77085,1},{{80},77100,1},{{0},77235,1},{{87},77250,1},{{0},77385,1},{{85},77400,1},{{0},77535,1},{{87},77550,1},{{0},77685,1},{{80},77700,1},{{0},77835,1},{{87},77850,1},{{0},77985,1},{{84},78000,1},{{0},78135,1},{{87},78150,1},{{0},78285,1},{{80},78300,1},{{0},78435,1},{{87},78450,1},{{0},78585,1},{{84},78600,1},{{0},78735,1},{{87},78750,1},{{0},78885,1},{{80},78900,1},{{0},79035,1},{{87},79050,1},{{0},79185,1},{{84},79200,1},{{0},79335,1},{{87},79350,1},{{0},79485,1},{{80},79500,1},{{0},80040,1},{{75,71,66},80100,3},{{0},80505,1},{{68},80850,1},{{0},80985,1},{{71},81000,1},{{0},81135,1},{{75},81150,1},{{0},81285,1},{{73,70,66},81300,3},{{0},81840,1},{{78,73,66},81900,3},{{0},82440,1},{{73},82500,1},{{0},82905,1},{{82},82950,1},{{0},83085,1},{{80},83100,1},{{0},83505,1},{{79},83550,1},{{0},83685,1},{{80},83700,1},{{0},84240,1},{{87},84300,1},{{0},84840,1},{{80},84900,1},{{0},85440,1},{{87,80},85500,2},{{0},86040,1},{{85},86100,1},{{0},86370,1},{{85},86400,1},{{0},86468,1},{{87},86475,1},{{0},86542,1},{{85},86550,1},{{0},86685,1},{{82},86700,1},{{0},86970,1},{{78},87000,1},{{0},87270,1},{{80},87300,1},{{0},89310,1},{{75},89400,1},{{0},89535,1},{{68},89550,1},{{0},89685,1},{{75,71,66},89700,3},{{0},90105,1},{{68},90450,1},{{0},90585,1},{{71},90600,1},{{0},90735,1},{{75},90750,1},{{0},90885,1},{{73,70,66},90900,3},{{0},91440,1},{{78,73,66},91500,3},{{0},92040,1},{{73},92100,1},{{0},92370,1},{{79},92400,1},{{0},92670,1},{{80},92700,1},{{0},92970,1},{{82},93000,1},{{0},93270,1},{{75},93300,1},{{0},93435,1},{{83},93450,1},{{0},93585,1},{{73},93600,1},{{0},93735,1},{{82},93750,1},{{0},93885,1},{{71},93900,1},{{0},94035,1},{{80},94050,1},{{0},94185,1},{{70},94200,1},{{0},94335,1},{{78},94350,1},{{0},94485,1},{{80},94500,1},{{0},94635,1},{{87},94650,1},{{0},94785,1},{{85},94800,1},{{0},94935,1},{{87},94950,1},{{0},95085,1},{{80},95100,1},{{0},95235,1},{{87},95250,1},{{0},95385,1},{{85},95400,1},{{0},95535,1},{{87},95550,1},{{0},95685,1},{{80},95700,1},{{0},95835,1},{{87},95850,1},{{0},95985,1},{{85},96000,1},{{0},96135,1},{{87},96150,1},{{0},96285,1},{{80},96300,1},{{0},96435,1},{{87},96450,1},{{0},96585,1},{{85},96600,1},{{0},96735,1},{{87},96750,1},{{0},96885,1},{{80},96900,1},{{0},97035,1},{{87},97050,1},{{0},97185,1},{{84},97200,1},{{0},97335,1},{{87},97350,1},{{0},97485,1},{{80},97500,1},{{0},97635,1},{{87},97650,1},{{0},97785,1},{{84},97800,1},{{0},97935,1},{{87},97950,1},{{0},98085,1},{{80},98100,1},{{0},98235,1},{{87},98250,1},{{0},98385,1},{{84},98400,1},{{0},98535,1},{{87},98550,1},{{0},98685,1},{{80},98700,1},{{0},98970,1},{{75},99000,1},{{0},99270,1},{{83},99300,1},{{0},99435,1},{{75},99450,1},{{0},99585,1},{{82},99600,1},{{0},99735,1},{{75},99750,1},{{0},99885,1},{{83},99900,1},{{0},100035,1},{{75},100050,1},{{0},100185,1},{{85},100200,1},{{0},100335,1},{{75},100350,1},{{0},100485,1},{{82},100500,1},{{0},100635,1},{{70},100650,1},{{0},100785,1},{{80},100800,1},{{0},100935,1},{{70},100950,1},{{0},101085,1},{{78},101100,1},{{0},101370,1},{{75},101400,1},{{0},101535,1},{{78},101550,1},{{0},101685,1},{{80},101700,1},{{0},101835,1},{{71},101850,1},{{0},101985,1},{{78},102000,1},{{0},102135,1},{{71},102150,1},{{0},102285,1},{{80},102300,1},{{0},102435,1},{{71},102450,1},{{0},102585,1},{{83},102600,1},{{0},102735,1},{{71},102750,1},{{0},102885,1},{{78},102900,1},{{0},103035,1},{{71},103050,1},{{0},103185,1},{{76},103200,1},{{0},103335,1},{{71},103350,1},{{0},103485,1},{{75},103500,1},{{0},103770,1},{{75},103800,1},{{0},103935,1},{{78},103950,1},{{0},104085,1},{{76},104100,1},{{0},104235,1},{{68},104250,1},{{0},104385,1},{{75},104400,1},{{0},104535,1},{{68},104550,1},{{0},104685,1},{{73},104700,1},{{0},104835,1},{{68},104850,1},{{0},104985,1},{{76},105000,1},{{0},105135,1},{{68},105150,1},{{0},105285,1},{{75},105300,1},{{0},105435,1},{{68},105450,1},{{0},105585,1},{{73},105600,1},{{0},105735,1},{{68},105750,1},{{0},105885,1},{{71},105900,1},{{0},106035,1},{{68},106050,1},{{0},106185,1},{{75},106200,1},{{0},106335,1},{{68},106350,1},{{0},106485,1},{{73},106500,1},{{0},106635,1},{{64},106650,1},{{0},106785,1},{{71},106800,1},{{0},106935,1},{{64},106950,1},{{0},107085,1},{{70},107100,1},{{0},107235,1},{{64},107250,1},{{0},107385,1},{{68},107400,1},{{0},107535,1},{{64},107550,1},{{0},107685,1},{{67},107700,1},{{0},107835,1},{{63},107850,1},{{0},107985,1},{{68},108000,1},{{0},108135,1},{{63},108150,1},{{0},108285,1},{{70},108300,1},{{0},108570,1},{{63},108600,1},{{0},108870,1},{{71},108900,1},{{0},109035,1},{{63},109050,1},{{0},109185,1},{{70},109200,1},{{0},109335,1},{{63},109350,1},{{0},109485,1},{{71},109500,1},{{0},109635,1},{{63},109650,1},{{0},109785,1},{{73},109800,1},{{0},109935,1},{{63},109950,1},{{0},110085,1},{{70},110100,1},{{0},110235,1},{{58},110250,1},{{0},110385,1},{{68},110400,1},{{0},110535,1},{{58},110550,1},{{0},110685,1},{{66},110700,1},{{0},110970,1},{{63},111000,1},{{0},111135,1},{{66},111150,1},{{0},111285,1},{{68},111300,1},{{0},111435,1},{{59},111450,1},{{0},111585,1},{{68},111600,1},{{0},111735,1},{{66},111750,1},{{0},111885,1},{{68},111900,1},{{0},112035,1},{{70},112050,1},{{0},112185,1},{{71},112200,1},{{0},112335,1},{{68},112350,1},{{0},112485,1},{{66},112500,1},{{0},112635,1},{{59},112650,1},{{0},112785,1},{{64},112800,1},{{0},112935,1},{{59},112950,1},{{0},113085,1},{{63},113100,1},{{0},113370,1},{{63},113400,1},{{0},113535,1},{{66},113550,1},{{0},113685,1},{{64},113700,1},{{0},113970,1},{{76},114000,1},{{0},114135,1},{{75},114150,1},{{0},114285,1},{{73},114300,1},{{0},114435,1},{{71},114450,1},{{0},114585,1},{{70},114600,1},{{0},114735,1},{{75},114900,1},{{0},115035,1},{{73},115050,1},{{0},115185,1},{{75},115200,1},{{0},115335,1},{{76},115350,1},{{0},115485,1},{{75},115500,1},{{0},115635,1},{{73},115650,1},{{0},115785,1},{{71},115800,1},{{0},115935,1},{{70},115950,1},{{0},116085,1},{{68},116100,1},{{0},116370,1},{{75},116400,1},{{0},116670,1},{{67},116700,1},{{0},116970,1},{{75},117000,1},{{0},117270,1},{{68},117300,1},{{0},118380,1},{{80},118500,1},{{0},118635,1},{{68},118650,1},{{0},118785,1},{{71},118800,1},{{0},118935,1},{{76},118950,1},{{0},119085,1},{{80},119100,1},{{0},119235,1},{{71},119250,1},{{0},119385,1},{{76},119400,1},{{0},119535,1},{{80},119550,1},{{0},119685,1},{{82},119700,1},{{0},119835,1},{{73},119850,1},{{0},119985,1},{{75},120000,1},{{0},120135,1},{{80},120150,1},{{0},120285,1},{{82},120300,1},{{0},120435,1},{{73},120450,1},{{0},120585,1},{{83},120600,1},{{0},120735,1},{{82},120750,1},{{0},120885,1},{{80},120900,1},{{0},121035,1},{{75},121050,1},{{0},121185,1},{{83},121200,1},{{0},121335,1},{{75},121350,1},{{0},121485,1},{{82},121500,1},{{0},121635,1},{{75},121650,1},{{0},121785,1},{{78},121800,1},{{0},121935,1},{{75},121950,1},{{0},122085,1},{{80},122100,1},{{0},122235,1},{{71},122250,1},{{0},122385,1},{{78},122400,1},{{0},122535,1},{{71},122550,1},{{0},122685,1},{{75},122700,1},{{0},122835,1},{{71},122850,1},{{0},122985,1},{{78},123000,1},{{0},123135,1},{{71},123150,1},{{0},123285,1},{{80},123300,1},{{0},123435,1},{{68},123450,1},{{0},123585,1},{{71},123600,1},{{0},123735,1},{{76},123750,1},{{0},123885,1},{{80},123900,1},{{0},124035,1},{{71},124050,1},{{0},124185,1},{{76},124200,1},{{0},124335,1},{{80},124350,1},{{0},124485,1},{{82},124500,1},{{0},124635,1},{{73},124650,1},{{0},124785,1},{{75},124800,1},{{0},124935,1},{{80},124950,1},{{0},125085,1},{{82},125100,1},{{0},125235,1},{{73},125250,1},{{0},125385,1},{{83},125400,1},{{0},125535,1},{{82},125550,1},{{0},125685,1},{{80},125700,1},{{0},125835,1},{{71},125850,1},{{0},125985,1},{{83},126000,1},{{0},126135,1},{{71},126150,1},{{0},126285,1},{{85},126300,1},{{0},126435,1},{{73},126450,1},{{0},126585,1},{{87},126600,1},{{0},126735,1},{{73},126750,1},{{0},126885,1},{{85},126900,1},{{0},127035,1},{{73},127050,1},{{0},127185,1},{{83},127200,1},{{0},127605,1},{{80},127800,1},{{0},128070,1},{{80},128100,1},{{0},128235,1},{{68},128250,1},{{0},128385,1},{{71},128400,1},{{0},128535,1},{{76},128550,1},{{0},128685,1},{{80},128700,1},{{0},128835,1},{{71},128850,1},{{0},128985,1},{{76},129000,1},{{0},129135,1},{{80},129150,1},{{0},129285,1},{{82},129300,1},{{0},129435,1},{{73},129450,1},{{0},129585,1},{{75},129600,1},{{0},129735,1},{{80},129750,1},{{0},129885,1},{{82},129900,1},{{0},130035,1},{{73},130050,1},{{0},130185,1},{{83},130200,1},{{0},130335,1},{{82},130350,1},{{0},130485,1},{{80},130500,1},{{0},130635,1},{{75},130650,1},{{0},130785,1},{{83},130800,1},{{0},130935,1},{{75},130950,1},{{0},131085,1},{{82},131100,1},{{0},131235,1},{{75},131250,1},{{0},131385,1},{{78},131400,1},{{0},131535,1},{{75},131550,1},{{0},131685,1},{{80},131700,1},{{0},131835,1},{{71},131850,1},{{0},131985,1},{{78},132000,1},{{0},132135,1},{{71},132150,1},{{0},132285,1},{{75},132300,1},{{0},132435,1},{{71},132450,1},{{0},132585,1},{{78},132600,1},{{0},132735,1},{{71},132750,1},{{0},132885,1},{{80},132900,1},{{0},133035,1},{{68},133050,1},{{0},133185,1},{{71},133200,1},{{0},133335,1},{{76},133350,1},{{0},133485,1},{{80},133500,1},{{0},133635,1},{{71},133650,1},{{0},133785,1},{{76},133800,1},{{0},133935,1},{{80},133950,1},{{0},134085,1},{{82},134100,1},{{0},134235,1},{{73},134250,1},{{0},134385,1},{{75},134400,1},{{0},134535,1},{{80},134550,1},{{0},134685,1},{{82},134700,1},{{0},134835,1},{{73},134850,1},{{0},134985,1},{{83},135000,1},{{0},135135,1},{{82},135150,1},{{0},135285,1},{{80},135300,1},{{0},136380,1},{{80},137400,1},{{0},137670,1},{{80},137700,1},{{0},137835,1},{{68},137850,1},{{0},137985,1},{{71},138000,1},{{0},138135,1},{{76},138150,1},{{0},138285,1},{{80},138300,1},{{0},138435,1},{{71},138450,1},{{0},138585,1},{{76},138600,1},{{0},138735,1},{{80},138750,1},{{0},138885,1},{{82},138900,1},{{0},139035,1},{{73},139050,1},{{0},139185,1},{{75},139200,1},{{0},139335,1},{{80},139350,1},{{0},139485,1},{{82},139500,1},{{0},139635,1},{{73},139650,1},{{0},139785,1},{{83},139800,1},{{0},139935,1},{{82},139950,1},{{0},140085,1},{{80},140100,1},{{0},140235,1},{{75},140250,1},{{0},140385,1},{{83},140400,1},{{0},140535,1},{{75},140550,1},{{0},140685,1},{{82},140700,1},{{0},140835,1},{{75},140850,1},{{0},140985,1},{{78},141000,1},{{0},141135,1},{{75},141150,1},{{0},141285,1},{{80},141300,1},{{0},141435,1},{{71},141450,1},{{0},141585,1},{{78},141600,1},{{0},141735,1},{{71},141750,1},{{0},141885,1},{{75},141900,1},{{0},142035,1},{{71},142050,1},{{0},142185,1},{{78},142200,1},{{0},142335,1},{{71},142350,1},{{0},142485,1},{{80},142500,1},{{0},142635,1},{{68},142650,1},{{0},142785,1},{{71},142800,1},{{0},142935,1},{{76},142950,1},{{0},143085,1},{{80},143100,1},{{0},143235,1},{{71},143250,1},{{0},143385,1},{{76},143400,1},{{0},143535,1},{{80},143550,1},{{0},143685,1},{{82},143700,1},{{0},143835,1},{{73},143850,1},{{0},143985,1},{{75},144000,1},{{0},144135,1},{{80},144150,1},{{0},144285,1},{{82},144300,1},{{0},144435,1},{{73},144450,1},{{0},144585,1},{{83},144600,1},{{0},144735,1},{{82},144750,1},{{0},144885,1},{{80},144900,1},{{0},145035,1},{{71},145050,1},{{0},145185,1},{{83},145200,1},{{0},145335,1},{{71},145350,1},{{0},145485,1},{{85},145500,1},{{0},145635,1},{{73},145650,1},{{0},145785,1},{{87},145800,1},{{0},145935,1},{{73},145950,1},{{0},146085,1},{{85},146100,1},{{0},146235,1},{{73},146250,1},{{0},146385,1},{{83},146400,1},{{0},146805,1},{{80},147000,1},{{0},147270,1},{{80},147300,1},{{0},147435,1},{{68},147450,1},{{0},147585,1},{{71},147600,1},{{0},147735,1},{{76},147750,1},{{0},147885,1},{{80},147900,1},{{0},148035,1},{{71},148050,1},{{0},148185,1},{{76},148200,1},{{0},148335,1},{{80},148350,1},{{0},148485,1},{{82},148500,1},{{0},148635,1},{{73},148650,1},{{0},148785,1},{{75},148800,1},{{0},148935,1},{{80},148950,1},{{0},149085,1},{{82},149100,1},{{0},149235,1},{{73},149250,1},{{0},149385,1},{{83},149400,1},{{0},149535,1},{{82},149550,1},{{0},149685,1},{{82},149700,1},{{0},149835,1},{{75},149850,1},{{0},149985,1},{{83},150000,1},{{0},150135,1},{{75},150150,1},{{0},150285,1},{{82},150300,1},{{0},150435,1},{{75},150450,1},{{0},150585,1},{{78},150600,1},{{0},150735,1},{{75},150750,1},{{0},150885,1},{{80},150900,1},{{0},151035,1},{{71},151050,1},{{0},151185,1},{{78},151200,1},{{0},151335,1},{{71},151350,1},{{0},151485,1},{{75},151500,1},{{0},151635,1},{{71},151650,1},{{0},151785,1},{{78},151800,1},{{0},151935,1},{{71},151950,1},{{0},152085,1},{{80},152100,1},{{0},152370,1},{{71},152400,1},{{0},152670,1},{{80},152700,1},{{0},152835,1},{{71},152850,1},{{0},152985,1},{{76},153000,1},{{0},153135,1},{{80},153150,1},{{0},153285,1},{{82},153300,1},{{0},153435,1},{{73},153450,1},{{0},153585,1},{{75},153600,1},{{0},153735,1},{{80},153750,1},{{0},153885,1},{{82},153900,1},{{0},154035,1},{{73},154050,1},{{0},154185,1},{{83},154200,1},{{0},154335,1},{{82},154350,1},{{0},154485,1},{{80},154500,1},{{0},156780,1},{{80},156900,1},{{0},157035,1},{{68},157050,1},{{0},157185,1},{{71},157200,1},{{0},157335,1},{{76},157350,1},{{0},157485,1},{{80},157500,1},{{0},157635,1},{{71},157650,1},{{0},157785,1},{{76},157800,1},{{0},157935,1},{{80},157950,1},{{0},158085,1},{{82},158100,1},{{0},158235,1},{{73},158250,1},{{0},158385,1},{{75},158400,1},{{0},158535,1},{{80},158550,1},{{0},158685,1},{{82},158700,1},{{0},158835,1},{{73},158850,1},{{0},158985,1},{{83},159000,1},{{0},159135,1},{{82},159150,1},{{0},159285,1},{{82},159300,1},{{0},159435,1},{{75},159450,1},{{0},159585,1},{{83},159600,1},{{0},159735,1},{{75},159750,1},{{0},159885,1},{{82},159900,1},{{0},160035,1},{{75},160050,1},{{0},160185,1},{{78},160200,1},{{0},160335,1},{{75},160350,1},{{0},160485,1},{{80},160500,1},{{0},160635,1},{{71},160650,1},{{0},160785,1},{{78},160800,1},{{0},160935,1},{{71},160950,1},{{0},161085,1},{{75},161100,1},{{0},161235,1},{{71},161250,1},{{0},161385,1},{{78},161400,1},{{0},161535,1},{{71},161550,1},{{0},161685,1},{{80},161700,1},{{0},161835,1},{{71},162000,1},{{0},162135,1},{{76},162150,1},{{0},162285,1},{{80},162300,1},{{0},162435,1},{{71},162450,1},{{0},162585,1},{{76},162600,1},{{0},162735,1},{{80},162750,1},{{0},162885,1},{{82},162900,1},{{0},163035,1},{{75},163200,1},{{0},163335,1},{{80},163350,1},{{0},163485,1},{{82},163500,1},{{0},163635,1},{{73},163650,1},{{0},163785,1},{{83},163800,1},{{0},163935,1},{{82},163950,1},{{0},164085,1},{{80},164100,1},{{0},164235,1},{{71},164250,1},{{0},164385,1},{{83},164400,1},{{0},164535,1},{{71},164550,1},{{0},164685,1},{{85},164700,1},{{0},164835,1},{{73},164850,1},{{0},164985,1},{{87},165000,1},{{0},165135,1},{{73},165150,1},{{0},165285,1},{{85},165300,1},{{0},165435,1},{{73},165450,1},{{0},165585,1},{{83},165600,1},{{0},166005,1},{{80},166200,1},{{0},166470,1},{{80},166500,1},{{0},166635,1},{{68},166650,1},{{0},166785,1},{{71},166800,1},{{0},166935,1},{{76},166950,1},{{0},167085,1},{{80},167100,1},{{0},167235,1},{{71},167250,1},{{0},167385,1},{{76},167400,1},{{0},167535,1},{{80},167550,1},{{0},167685,1},{{82},167700,1},{{0},167835,1},{{73},167850,1},{{0},167985,1},{{75},168000,1},{{0},168135,1},{{80},168150,1},{{0},168285,1},{{82},168300,1},{{0},168435,1},{{73},168450,1},{{0},168585,1},{{83},168600,1},{{0},168735,1},{{82},168750,1},{{0},168885,1},{{82},168900,1},{{0},169035,1},{{75},169050,1},{{0},169185,1},{{83},169200,1},{{0},169335,1},{{75},169350,1},{{0},169485,1},{{82},169500,1},{{0},169635,1},{{75},169650,1},{{0},169785,1},{{78},169800,1},{{0},169935,1},{{75},169950,1},{{0},170085,1},{{80},170100,1},{{0},170235,1},{{71},170250,1},{{0},170385,1},{{78},170400,1},{{0},170535,1},{{71},170550,1},{{0},170685,1},{{75},170700,1},{{0},170835,1},{{71},170850,1},{{0},170985,1},{{78},171000,1},{{0},171135,1},{{71},171150,1},{{0},171285,1},{{80},171300,1},{{0},171570,1},{{71},171600,1},{{0},171870,1},{{80},171900,1},{{0},172035,1},{{71},172050,1},{{0},172185,1},{{76},172200,1},{{0},172335,1},{{80},172350,1},{{0},172485,1},{{82},172500,1},{{0},172635,1},{{73},172650,1},{{0},172785,1},{{75},172800,1},{{0},172935,1},{{80},172950,1},{{0},173085,1},{{82},173100,1},{{0},173235,1},{{73},173250,1},{{0},173385,1},{{83},173400,1},{{0},173535,1},{{82},173550,1},{{0},173685,1},{{80},173700,1},{{0},174240,1},{{61},174300,1},{{0},174435,1},{{63},174450,1},{{0},174585,1},{{68},174600,1},{{0},174735,1},{{73},174750,1},{{0},174885,1},{{75},174900,1},{{0},175035,1},{{80},175050,1},{{0},175185,1},{{85},175200,1},{{0},175335,1},{{87},175350,1},{{0},175485,1},{{99,97,92},175500,3},{{0},176040,1},{{80},176100,1},{{0},176235,1},{{68},176250,1},{{0},176385,1},{{71},176400,1},{{0},176535,1},{{76},176550,1},{{0},176685,1},{{80},176700,1},{{0},176835,1},{{71},176850,1},{{0},176985,1},{{76},177000,1},{{0},177135,1},{{80},177150,1},{{0},177285,1},{{82},177300,1},{{0},177435,1},{{73},177450,1},{{0},177585,1},{{75},177600,1},{{0},177735,1},{{80},177750,1},{{0},177885,1},{{82},177900,1},{{0},178035,1},{{73},178050,1},{{0},178185,1},{{83},178200,1},{{0},178335,1},{{82},178350,1},{{0},178485,1},{{82},178500,1},{{0},178635,1},{{75},178650,1},{{0},178785,1},{{83},178800,1},{{0},178935,1},{{75},178950,1},{{0},179085,1},{{82},179100,1},{{0},179235,1},{{75},179250,1},{{0},179385,1},{{78},179400,1},{{0},179535,1},{{75},179550,1},{{0},179685,1},{{80},179700,1},{{0},179835,1},{{71},179850,1},{{0},179985,1},{{78},180000,1},{{0},180135,1},{{71},180150,1},{{0},180285,1},{{75},180300,1},{{0},180435,1},{{71},180450,1},{{0},180585,1},{{78},180600,1},{{0},180735,1},{{71},180750,1},{{0},180885,1},{{80},180900,1},{{0},181035,1},{{71},181200,1},{{0},181335,1},{{76},181350,1},{{0},181485,1},{{80},181500,1},{{0},181635,1},{{71},181650,1},{{0},181785,1},{{76},181800,1},{{0},181935,1},{{80},181950,1},{{0},182085,1},{{82},182100,1},{{0},182235,1},{{73},182250,1},{{0},182385,1},{{75},182400,1},{{0},182535,1},{{80},182550,1},{{0},182685,1},{{82},182700,1},{{0},182835,1},{{73},182850,1},{{0},182985,1},{{83},183000,1},{{0},183135,1},{{82},183150,1},{{0},183285,1},{{80},183300,1},{{0},183435,1},{{71},183450,1},{{0},183585,1},{{83},183600,1},{{0},183735,1},{{71},183750,1},{{0},183885,1},{{85},183900,1},{{0},184035,1},{{73},184050,1},{{0},184185,1},{{87},184200,1},{{0},184335,1},{{73},184350,1},{{0},184485,1},{{87},184500,1},{{0},184635,1},{{75},184650,1},{{0},184785,1},{{87},184800,1},{{0},184935,1},{{75},184950,1},{{0},185085,1},{{87},185100,1},{{0},185235,1},{{75},185250,1},{{0},185385,1},{{87},185400,1},{{0},185535,1},{{90},185550,1},{{0},185685,1},{{92},185700,1},{{0},185835,1},{{80},185850,1},{{0},185985,1},{{83},186000,1},{{0},186135,1},{{88},186150,1},{{0},186285,1},{{92},186300,1},{{0},186435,1},{{83},186450,1},{{0},186585,1},{{88},186600,1},{{0},186735,1},{{92},186750,1},{{0},186885,1},{{94},186900,1},{{0},187035,1},{{85},187050,1},{{0},187185,1},{{87},187200,1},{{0},187335,1},{{92},187350,1},{{0},187485,1},{{94},187500,1},{{0},187635,1},{{85},187650,1},{{0},187785,1},{{95},187800,1},{{0},187935,1},{{94},187950,1},{{0},188085,1},{{92},188100,1},{{0},188235,1},{{83},188250,1},{{0},188385,1},{{95},188400,1},{{0},188535,1},{{83},188550,1},{{0},188685,1},{{94},188700,1},{{0},188835,1},{{83},188850,1},{{0},188985,1},{{90},189000,1},{{0},189135,1},{{83},189150,1},{{0},189285,1},{{92},189300,1},{{0},189435,1},{{83},189450,1},{{0},189585,1},{{90},189600,1},{{0},189735,1},{{83},189750,1},{{0},189885,1},{{87},189900,1},{{0},190035,1},{{83},190050,1},{{0},190185,1},{{90},190200,1},{{0},190335,1},{{83},190350,1},{{0},190485,1},{{92},190500,1},{{0},190635,1},{{80},190650,1},{{0},190785,1},{{83},190800,1},{{0},190935,1},{{88},190950,1},{{0},191085,1},{{92},191100,1},{{0},191235,1},{{83},191250,1},{{0},191385,1},{{88},191400,1},{{0},191535,1},{{92},191550,1},{{0},191685,1},{{94},191700,1},{{0},191835,1},{{85},191850,1},{{0},191985,1},{{87},192000,1},{{0},192135,1},{{92},192150,1},{{0},192285,1},{{94},192300,1},{{0},192435,1},{{85},192450,1},{{0},192585,1},{{95},192600,1},{{0},192735,1},{{94},192750,1},{{0},192885,1},{{92,80},192900,2},{{0},193440,1},{{61},193500,1},{{0},193635,1},{{63},193650,1},{{0},193785,1},{{68},193800,1},{{0},193935,1},{{73},193950,1},{{0},194085,1},{{75},194100,1},{{0},194235,1},{{80},194250,1},{{0},194385,1},{{85},194400,1},{{0},194535,1},{{87},194550,1},{{0},194685,1},{{99,97,92},194700,3},{{0},195240,1},{{73},196650,1},{{0},196785,1},{{75},196800,1},{{0},196935,1},{{83},196950,1},{{0},197085,1},{{82},197100,1},{{0},197235,1},{{80},197250,1},{{0},197385,1},{{82},197400,1},{{0},197535,1},{{79},197550,1},{{0},197685,1},{{83},197700,1},{{0},197835,1},{{75},197850,1},{{0},197985,1},{{82},198000,1},{{0},198135,1},{{75},198150,1},{{0},198285,1},{{83},198300,1},{{0},198435,1},{{75},198450,1},{{0},198585,1},{{85},198600,1},{{0},198735,1},{{75},198750,1},{{0},198885,1},{{82},198900,1},{{0},199035,1},{{70},199050,1},{{0},199185,1},{{80},199200,1},{{0},199335,1},{{70},199350,1},{{0},199485,1},{{78},199500,1},{{0},199770,1},{{75},199800,1},{{0},199935,1},{{78},199950,1},{{0},200085,1},{{80},200100,1},{{0},200235,1},{{71},200250,1},{{0},200385,1},{{78},200400,1},{{0},200535,1},{{71},200550,1},{{0},200685,1},{{80},200700,1},{{0},200835,1},{{71},200850,1},{{0},200985,1},{{83},201000,1},{{0},201135,1},{{71},201150,1},{{0},201285,1},{{78},201300,1},{{0},201435,1},{{71},201450,1},{{0},201585,1},{{76},201600,1},{{0},201735,1},{{71},201750,1},{{0},201885,1},{{75},201900,1},{{0},202170,1},{{75},202200,1},{{0},202335,1},{{78},202350,1},{{0},202485,1},{{76},202500,1},{{0},202635,1},{{68},202650,1},{{0},202785,1},{{75},202800,1},{{0},202935,1},{{68},202950,1},{{0},203085,1},{{73},203100,1},{{0},203235,1},{{68},203250,1},{{0},203385,1},{{76},203400,1},{{0},203535,1},{{68},203550,1},{{0},203685,1},{{75},203700,1},{{0},203835,1},{{68},203850,1},{{0},203985,1},{{73},204000,1},{{0},204135,1},{{68},204150,1},{{0},204285,1},{{71},204300,1},{{0},204435,1},{{68},204450,1},{{0},204585,1},{{75},204600,1},{{0},204735,1},{{68},204750,1},{{0},204885,1},{{73},204900,1},{{0},205035,1},{{64},205050,1},{{0},205185,1},{{71},205200,1},{{0},205335,1},{{64},205350,1},{{0},205485,1},{{70},205500,1},{{0},205635,1},{{64},205650,1},{{0},205785,1},{{68},205800,1},{{0},205935,1},{{64},205950,1},{{0},206085,1},{{67},206100,1},{{0},206235,1},{{63},206250,1},{{0},206385,1},{{68},206400,1},{{0},206535,1},{{63},206550,1},{{0},206685,1},{{70},206700,1},{{0},206970,1},{{63},207000,1},{{0},207270,1},{{71},207300,1},{{0},207435,1},{{63},207450,1},{{0},207585,1},{{70},207600,1},{{0},207735,1},{{63},207750,1},{{0},207885,1},{{71},207900,1},{{0},208035,1},{{63},208050,1},{{0},208185,1},{{73},208200,1},{{0},208335,1},{{63},208350,1},{{0},208485,1},{{70},208500,1},{{0},208635,1},{{58},208650,1},{{0},208785,1},{{68},208800,1},{{0},208935,1},{{58},208950,1},{{0},209085,1},{{66},209100,1},{{0},209370,1},{{63},209400,1},{{0},209535,1},{{66},209550,1},{{0},209685,1},{{68},209700,1},{{0},209835,1},{{59},209850,1},{{0},209985,1},{{68},210000,1},{{0},210135,1},{{66},210150,1},{{0},210285,1},{{68},210300,1},{{0},210435,1},{{70},210450,1},{{0},210585,1},{{71},210600,1},{{0},210735,1},{{68},210750,1},{{0},210885,1},{{66},210900,1},{{0},211035,1},{{59},211050,1},{{0},211185,1},{{64},211200,1},{{0},211335,1},{{59},211350,1},{{0},211485,1},{{63},211500,1},{{0},211770,1},{{63},211800,1},{{0},211935,1},{{66},211950,1},{{0},212085,1},{{64},212100,1},{{0},212370,1},{{76},212400,1},{{0},212535,1},{{75},212550,1},{{0},212685,1},{{73},212700,1},{{0},212835,1},{{71},212850,1},{{0},212985,1},{{70},213000,1},{{0},213135,1},{{75},213300,1},{{0},213435,1},{{73},213450,1},{{0},213585,1},{{75},213600,1},{{0},213735,1},{{76},213750,1},{{0},213885,1},{{75},213900,1},{{0},214035,1},{{73},214050,1},{{0},214185,1},{{71},214200,1},{{0},214335,1},{{70},214350,1},{{0},214485,1},{{68},214500,1},{{0},214770,1},{{75},214800,1},{{0},215070,1},{{67},215100,1},{{0},215370,1},{{75},215400,1},{{0},215670,1},{{68},215700,1},{{0},216780,1},{{71},216900,1},{{0},217035,1},{{63},217050,1},{{0},217185,1},{{70},217200,1},{{0},217335,1},{{63},217350,1},{{0},217485,1},{{71},217500,1},{{0},217635,1},{{63},217650,1},{{0},217785,1},{{73},217800,1},{{0},217935,1},{{63},217950,1},{{0},218085,1},{{70},218100,1},{{0},218235,1},{{58},218250,1},{{0},218385,1},{{75},218400,1},{{0},218535,1},{{58},218550,1},{{0},218685,1},{{66},218700,1},{{0},218970,1},{{63},219000,1},{{0},219135,1},{{66},219150,1},{{0},219285,1},{{68},219300,1},{{0},219435,1},{{59},219450,1},{{0},219585,1},{{68},219600,1},{{0},219735,1},{{66},219750,1},{{0},219885,1},{{68},219900,1},{{0},220035,1},{{70},220050,1},{{0},220185,1},{{71},220200,1},{{0},220335,1},{{68},220350,1},{{0},220485,1},{{66},220500,1},{{0},220635,1},{{59},220650,1},{{0},220785,1},{{64},220800,1},{{0},220935,1},{{59},220950,1},{{0},221085,1},{{63},221100,1},{{0},221370,1},{{63},221400,1},{{0},221535,1},{{66},221550,1},{{0},221685,1},{{64},221700,1},{{0},221970,1},{{76},222000,1},{{0},222135,1},{{75},222150,1},{{0},222285,1},{{73},222300,1},{{0},222435,1},{{71},222450,1},{{0},222585,1},{{70},222600,1},{{0},222735,1},{{75},223200,1},{{0},223335,1},{{73},223350,1},{{0},223485,1},{{71},223500,1},{{0},223635,1},{{70},223650,1},{{0},223785,1},{{68},223800,1},{{0},224070,1},{{88},224400,1},{{0},224535,1},{{87},224550,1},{{0},224685,1},{{85},224700,1},{{0},224835,1},{{83},224850,1},{{0},224985,1},{{82},225000,1},{{0},225135,1},{{80},225150,1},{{0},225285,1},{{79},225300,1},{{0},225435,1},{{76},225450,1},{{0},225585,1},{{75},225600,1},{{0},225735,1},{{73},225750,1},{{0},225885,1},{{71},225900,1},{{0},226035,1},{{70},226050,1},{{0},226185,1},{{68},226200,1},{{0},226335,1},{{67},226350,1},{{0},226485,1},{{71},226500,1},{{0},226635,1},{{63},226650,1},{{0},226785,1},{{70},226800,1},{{0},226935,1},{{63},226950,1},{{0},227085,1},{{71},227100,1},{{0},227235,1},{{63},227250,1},{{0},227385,1},{{73},227400,1},{{0},227535,1},{{63},227550,1},{{0},227685,1},{{70},227700,1},{{0},227835,1},{{58},227850,1},{{0},227985,1},{{75},228000,1},{{0},228135,1},{{58},228150,1},{{0},228285,1},{{66},228300,1},{{0},228570,1},{{63},228600,1},{{0},228735,1},{{66},228750,1},{{0},228885,1},{{68},228900,1},{{0},229035,1},{{59},229050,1},{{0},229185,1},{{68},229200,1},{{0},229335,1},{{66},229350,1},{{0},229485,1},{{68},229500,1},{{0},229635,1},{{70},229650,1},{{0},229785,1},{{71},229800,1},{{0},229935,1},{{68},229950,1},{{0},230085,1},{{66},230100,1},{{0},230235,1},{{59},230250,1},{{0},230385,1},{{64},230400,1},{{0},230535,1},{{59},230550,1},{{0},230685,1},{{63},230700,1},{{0},230970,1},{{63},231000,1},{{0},231135,1},{{66},231150,1},{{0},231285,1},{{64},231300,1},{{0},231570,1},{{76},231600,1},{{0},231735,1},{{75},231750,1},{{0},231885,1},{{73},231900,1},{{0},232035,1},{{71},232050,1},{{0},232185,1},{{70},232200,1},{{0},232335,1},{{75},232500,1},{{0},232635,1},{{73},232800,1},{{0},232935,1},{{76},232950,1},{{0},233085,1},{{75},233100,1},{{0},233235,1},{{73},233250,1},{{0},233385,1},{{71},233400,1},{{0},233535,1},{{70},233550,1},{{0},233685,1},{{68},233700,1},{{0},233970,1},{{75},234000,1},{{0},234270,1},{{67},234300,1},{{0},234570,1},{{75},234600,1},{{0},234870,1},{{68},234900,1},{{0},235980,1},{{75},236100,1},{{0},236393,1},{{73},236426,1},{{0},236720,1},{{80},236752,1},{{0},237046,1},{{73},237078,1},{{0},237372,1},{{75},237404,1},{{0},237698,1},{{73},237730,1},{{0},238024,1},{{68},238057,1},{{0},238350,1},{{73},238383,1},{{0},238676,1},{{75},238709,1},{{0},239002,1},{{73},239035,1},{{0},239328,1},{{80},239361,1},{{0},239654,1},{{73},239687,1},{{0},239980,1},{{75},240013,1},{{0},240307,1},{{73},240339,1},{{0},240633,1},{{68},240665,1},{{0},240959,1},{{73},240991,1},{{0},241285,1},{{85,82},241480,2},{{0},241627,1},{{87,85},241643,2},{{0},241790,1},{{80},241970,1},{{0},242263,1},{{73},242296,1},{{0},242589,1},{{75},242622,1},{{0},242915,1},{{73},242948,1},{{0},243241,1},{{68},243274,1},{{0},243567,1},{{73},243600,1},{{0},243893,1},{{75},243926,1},{{0},244220,1},{{73},244252,1},{{0},244546,1},{{80},244578,1},{{0},244872,1},{{73},244904,1},{{0},245198,1},{{75},245230,1},{{0},245524,1},{{73},245557,1},{{0},245850,1},{{68},245883,1},{{0},246176,1},{{73},246209,1},{{0},246502,1},{{75},246535,1},{{0},246828,1},{{73},246861,1},{{0},247154,1},{{80},247187,1},{{0},247480,1},{{73},247513,1},{{0},247807,1},{{75},247839,1},{{0},248133,1},{{73},248165,1},{{0},248459,1},{{68},248491,1},{{0},248785,1},{{73},248817,1},{{0},249111,1},{{75},249143,1},{{0},249437,1},{{73},249470,1},{{0},249763,1},{{80},249796,1},{{0},250089,1},{{73},250122,1},{{0},250415,1},{{75},250448,1},{{0},250741,1},{{73},250774,1},{{0},251067,1},{{68},251100,1},{{0},251393,1},{{73},251426,1},{{0},251720,1},{{85,82},251915,2},{{0},252062,1},{{87,85},252078,2},{{0},252225,1},{{80},252404,1},{{0},252698,1},{{73},252730,1},{{0},253024,1},{{75},253056,1},{{0},253350,1},{{73},253383,1},{{0},253676,1},{{68},253709,1},{{0},254002,1},{{73},254035,1},{{0},254328,1},{{75},254361,1},{{0},254654,1},{{73},254687,1},{{0},254980,1},{{80},255013,1},{{0},255306,1},{{73},255339,1},{{0},255633,1},{{75},255665,1},{{0},255959,1},{{73},255991,1},{{0},256285,1},{{68},256317,1},{{0},256611,1},{{73},256643,1},{{0},256937,1}};
const uint8_t motor_control[] = {0x09, 0x01, 0x03, 0x02, 0x06, 0x04, 0x0c, 0x08};
uint8_t motor_control_phase = 0;

bool isLeapYear(uint16_t year);
void getTimeFromTimestamp(struct Time *time, uint64_t timestamp, uint32_t timeZone);
void updateSolarTermsTimestamp(uint64_t solarTermsTimestamp[], uint16_t year);
uint64_t getTimestampFromTime(struct Time *time, uint32_t timeZone);
void addTenMilliseconds(struct Time *time);
void minusTenMilliseconds(struct Time *time);
uint64_t readNumberFromString(char *string, char delimiter);

char convertNumberToChar(uint8_t number);
uint8_t getSegmentDisplayControlWord(char character);

void segmentDisplayBlink(char *segmentDisplayCharacter, uint64_t counter, uint8_t blinkDigitByte);
void LEDBlink(uint64_t counter, uint8_t blinkDigitByte);
uint8_t chordInterleavingSelection = 0;
const uint16_t noteFrequency[] = {0, 35, 37, 39, 41, 44, 46, 49, 52, 55, 58, 62, 66, 70, 74, 78, 83, 88, 93, 98, 104, 110, 117, 124, 131, 139, 147, 156, 165, 175, 186, 197, 208, 221, 234, 248, 263, 278, 295, 312, 331, 351, 371, 393, 417, 442, 468, 496, 525, 556, 590, 625, 662, 701, 743, 787, 834, 883, 936, 992, 1051, 1113, 1179, 1249, 1324, 1402, 1486, 1574, 1668, 1767, 1872, 1983, 2101, 2226, 2358, 2499, 2647, 2804, 2971, 3148, 3335, 3533, 3744, 3966, 4202, 4452, 4717, 4997, 5294, 5609, 5943, 6296, 6670, 7067, 7487, 7932, 8404, 8904, 9433, 9994, 10588, 11218, 11885, 12592, 13341, 14134, 14974, 15865};

int main(void)
{
	uint8_t i = 0;

	uint8_t tempKeyboardStateByte = 0xff;

	//use internal 16M oscillator, HSI
	ui32SysClock = SysCtlClockFreqSet((SYSCTL_XTAL_16MHZ | SYSCTL_OSC_INT | SYSCTL_USE_OSC), 16000000);
	peripheralDeviceInput.keyPadStateByte = tempKeyboardStateByte;
	peripheralDeviceInput.UARTMessageReceiveFinishedCountdown = 1926;
	peripheralDeviceInput.UARTMessageTail = peripheralDeviceInput.UARTMessage;
	peripheralDeviceInput.QEIDirection = 1;
	peripheralDeviceOutput.beepFrequency = 0;
	peripheralDeviceOutput.lightLevel = NUMBERS_OF_LIGHT_LEVELS - 1;
	peripheralDeviceOutput.motorClockwise = true;
	peripheralDeviceOutput.motorCycle = 0;

	S800_GPIO_Init();
	S800_I2C0_Init();
	S800_UART_Init();
	S800_Int_Init();
	S800_QEI_Init();
	S800_PWM_Init();

	SysCtlPeripheralEnable(SYSCTL_PERIPH_EEPROM0);
	while (!SysCtlPeripheralReady(SYSCTL_PERIPH_EEPROM0))
		;

	EEPROMInit();

	while (1)
	{

		I2C0_WriteByte(PCA9557_I2CADDR, PCA9557_OUTPUT, ~peripheralDeviceOutput.LEDDisplayByte);

		peripheralDeviceInput.QEIDirection = QEIDirectionGet(QEI0_BASE);
		peripheralDeviceInput.QEIPosition = QEIPositionGet(QEI0_BASE);
		for (i = 0; i < 8; i++)
		{
			//在读写操作同时存在的情况下,似乎有时读得数据会变为0x0.取代直接读取按钮状态的代码,下列代码防止错误数据的传入.
			//放在循环内的原因是减少delay的影响,奇怪的是gpio的读取似乎不必这么做.
			tempKeyboardStateByte = I2C0_ReadByte(TCA6424_I2CADDR, TCA6424_INPUT_PORT0);
			if (tempKeyboardStateByte != 0x0)
				peripheralDeviceInput.keyPadStateByte = tempKeyboardStateByte;

			if (peripheralDeviceOutput.lightLevel > 0)
				flash_seg(i, peripheralDeviceOutput.segmentDisplayControlWord[i]);
			if (peripheralDeviceOutput.motorCycle > 0)
				GPIOPinWrite(GPIO_PORTF_BASE, GPIO_PIN_0 | GPIO_PIN_1 | GPIO_PIN_2 | GPIO_PIN_3, motor_control[8 - i]);
		}
		if (peripheralDeviceOutput.motorCycle > 0)
			peripheralDeviceOutput.motorCycle--;
		PWMOutputState(PWM0_BASE, (PWM_OUT_7_BIT), peripheralDeviceOutput.beepFrequency != 0);

		if (peripheralDeviceOutput.beepFrequency != 0)
		{
			PWMGenPeriodSet(PWM0_BASE, PWM_GEN_3, ui32SysClock / peripheralDeviceOutput.beepFrequency);
			PWMPulseWidthSet(PWM0_BASE, PWM_OUT_7, ui32SysClock / peripheralDeviceOutput.beepFrequency / 4);
		}

		peripheralDeviceInput.buttonStateByte = GPIOPinRead(GPIO_PORTJ_BASE, GPIO_PIN_1 | GPIO_PIN_0);
	}
	uint8_t test;
}
void flash_seg(uint8_t display_index, uint8_t control_word)
{
	I2C0_WriteByte(TCA6424_I2CADDR, TCA6424_OUTPUT_PORT1, control_word);
	I2C0_WriteByte(TCA6424_I2CADDR, TCA6424_OUTPUT_PORT2, (uint8_t)(1 << display_index));
	Delay((uint32_t)800 * peripheralDeviceOutput.lightLevel);
	// I2C0_WriteByte(PCA9557_I2CADDR, PCA9557_OUTPUT, ~((uint8_t)(1 << display_index)));
	I2C0_WriteByte(TCA6424_I2CADDR, TCA6424_OUTPUT_PORT2, (uint8_t)(0));
	Delay((uint32_t)800 * (NUMBERS_OF_LIGHT_LEVELS - 1 - peripheralDeviceOutput.lightLevel));
}

void S800_GPIO_Init(void)
{
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOF); //Enable PortF
	while (!SysCtlPeripheralReady(SYSCTL_PERIPH_GPIOF))
		;										 //Wait for the GPIO moduleF ready
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOJ); //Enable PortJ
	while (!SysCtlPeripheralReady(SYSCTL_PERIPH_GPIOJ))
		; //Wait for the GPIO moduleJ ready

	GPIOPinTypeGPIOOutput(GPIO_PORTF_BASE, GPIO_PIN_0 | GPIO_PIN_1 | GPIO_PIN_2 | GPIO_PIN_3); //Set PF0 as Output pin
																							   //Set PF0 as Output pin
	GPIOPinTypeGPIOInput(GPIO_PORTJ_BASE, GPIO_PIN_0 | GPIO_PIN_1);							   //Set the PJ0,PJ1 as input pin
	GPIOPadConfigSet(GPIO_PORTJ_BASE, GPIO_PIN_0 | GPIO_PIN_1, GPIO_STRENGTH_2MA, GPIO_PIN_TYPE_STD_WPU);
}
void S800_I2C0_Init(void)
{
	uint8_t result;
	SysCtlPeripheralEnable(SYSCTL_PERIPH_I2C0);		//初始化i2c模块
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOB);	//使用I2C模块0，引脚配置为I2C0SCL--PB2、I2C0SDA--PB3
	GPIOPinConfigure(GPIO_PB2_I2C0SCL);				//配置PB2为I2C0SCL
	GPIOPinConfigure(GPIO_PB3_I2C0SDA);				//配置PB3为I2C0SDA
	GPIOPinTypeI2CSCL(GPIO_PORTB_BASE, GPIO_PIN_2); //I2C将GPIO_PIN_2用作SCL
	GPIOPinTypeI2C(GPIO_PORTB_BASE, GPIO_PIN_3);	//I2C将GPIO_PIN_3用作SDA

	I2CMasterInitExpClk(I2C0_BASE, ui32SysClock, true); //config I2C0 400k
	I2CMasterEnable(I2C0_BASE);

	result = I2C0_WriteByte(TCA6424_I2CADDR, TCA6424_CONFIG_PORT0, 0x0ff); //config port 0 as input
	result = I2C0_WriteByte(TCA6424_I2CADDR, TCA6424_CONFIG_PORT1, 0x0);   //config port 1 as output
	result = I2C0_WriteByte(TCA6424_I2CADDR, TCA6424_CONFIG_PORT2, 0x0);   //config port 2 as output

	result = I2C0_WriteByte(PCA9557_I2CADDR, PCA9557_CONFIG, 0x00);	 //config port as output
	result = I2C0_WriteByte(PCA9557_I2CADDR, PCA9557_OUTPUT, 0x0ff); //turn off the LED1-8
}
void S800_UART_Init(void)
{
	SysCtlPeripheralEnable(SYSCTL_PERIPH_UART0);
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOA); //Enable PortA
	while (!SysCtlPeripheralReady(SYSCTL_PERIPH_GPIOA))
		; //Wait for the GPIO moduleA ready

	GPIOPinConfigure(GPIO_PA0_U0RX); // Set GPIO A0 and A1 as UART pins.
	GPIOPinConfigure(GPIO_PA1_U0TX);

	GPIOPinTypeUART(GPIO_PORTA_BASE, GPIO_PIN_0 | GPIO_PIN_1);

	// Configure the UART for 115,200, 8-N-1 operation.
	UARTConfigSetExpClk(UART0_BASE, ui32SysClock, 115200, (UART_CONFIG_WLEN_8 | UART_CONFIG_STOP_ONE | UART_CONFIG_PAR_NONE));
	UARTStringPut((uint8_t *)"\r\nHello, world!\r\n");
}
void S800_Int_Init(void)
{
	// IntPriorityGroupingSet(7);
	// IntPrioritySet(INT_GPIOJ, 0x20);

	SysTickPeriodSet(ui32SysClock / SYSTICK_FREQUENCY);
	SysTickEnable();
	SysTickIntEnable();

	UARTIntEnable(UART0_BASE, UART_INT_RX | UART_INT_RT);
	IntEnable(INT_UART0);

	IntMasterEnable();
}
void S800_QEI_Init(void)
{
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOL);
	// Enable the QEI0 peripheral
	SysCtlPeripheralEnable(SYSCTL_PERIPH_QEI0);
	// Wait for the QEI0 module to be ready.
	while (!SysCtlPeripheralReady(SYSCTL_PERIPH_QEI0))
	{
	}

	GPIOPinConfigure(GPIO_PL1_PHA0);
	GPIOPinConfigure(GPIO_PL2_PHB0);
	//software patch to force the PL3 to low voltage
	GPIOPinTypeGPIOOutput(GPIO_PORTL_BASE, GPIO_PIN_3);
	GPIOPinWrite(GPIO_PORTL_BASE, GPIO_PIN_3, 0);

	GPIOPinTypeQEI(GPIO_PORTL_BASE, GPIO_PIN_1);
	GPIOPinTypeQEI(GPIO_PORTL_BASE, GPIO_PIN_2);
	//
	// Configure the quadrature encoder to capture edges on both signals and
	// maintain an absolute position by resetting on index pulses. Using a
	// 1000 line encoder at four edges per line, there are 4000 pulses per
	// revolution; therefore set the maximum position to 3999 as the count
	// is zero based.
	//
	QEIConfigure(QEI0_BASE, (QEI_CONFIG_CAPTURE_A_B | QEI_CONFIG_NO_RESET | QEI_CONFIG_QUADRATURE | QEI_CONFIG_NO_SWAP), 100);
	// Enable the quadrature encoder.
	QEIEnable(QEI0_BASE);
}
void S800_PWM_Init(void)
{
	SysCtlPWMClockSet(SYSCTL_PWMDIV_1);
	//
	// Enable the PWM0 peripheral
	//
	SysCtlPeripheralEnable(SYSCTL_PERIPH_PWM0);
	//
	// Wait for the PWM0 module to be ready.
	//
	while (!SysCtlPeripheralReady(SYSCTL_PERIPH_PWM0))
		;
	SysCtlPeripheralEnable(SYSCTL_PERIPH_GPIOK); //Enable PortK
	while (!SysCtlPeripheralReady(SYSCTL_PERIPH_GPIOK))
		; //Wait for the GPIO moduleN readK
	GPIOPinConfigure(GPIO_PK5_M0PWM7);
	GPIOPinTypePWM(GPIO_PORTK_BASE, GPIO_PIN_5);
	//
	// Configure the PWM generator for count down mode with immediate updates
	// to the parameters.
	//
	PWMGenConfigure(PWM0_BASE, PWM_GEN_3, PWM_GEN_MODE_DOWN | PWM_GEN_MODE_NO_SYNC);
	//
	// Set the period. For a 50 KHz frequency, the period = 1/50,000, or 20
	// microseconds. For a 20 MHz clock, this translates to 400 clock ticks.
	// Use this value to set the period.
	//
	PWMGenPeriodSet(PWM0_BASE, PWM_GEN_3, ui32SysClock / 4000);

	PWMPulseWidthSet(PWM0_BASE, PWM_OUT_7, ui32SysClock / 12000);
	//
	// Enable the outputs.
	//
	// PWMOutputState(PWM0_BASE, (PWM_OUT_7_BIT), true);
	//
	// Start the timers in generator 0.
	//
	PWMGenEnable(PWM0_BASE, PWM_GEN_3);
}

void Delay(uint32_t value)
{
	uint32_t i = 0;
	for (; i < value; i++)
		;
}

void UARTStringPut(const char *cMessage)
{
	while (*cMessage != '\0')
		UARTCharPut(UART0_BASE, *(cMessage++));
}

void SysTick_Handler(void)
{
	uint8_t i = 0;
	static uint64_t counter;

	static struct Time time;
	static uint64_t timestampInUTC = 162309904000; //单位为0.01s
	uint32_t timestampInUTCHighBit = (timestampInUTC >> 32) & 0xffffffff, timestampInUTCLowBit = timestampInUTC & 0xffffffff;

	static struct Time countdownTime;
	static uint64_t countdownTimestamp;

	static struct Time alarmTime[NUMBER_OF_ALARMS];
	static uint64_t alarmTimestamp[NUMBER_OF_ALARMS];

	static uint16_t solarTermsCorespondingYear;
	static uint64_t solarTermsTimestamp[24];
	static struct Time solarTerms[24];

	static uint16_t bootCountdown;

	static uint32_t noteTime = 0, noteIndex = 0;

	static int8_t previousQEIDirection, previousQEIPosition;
	uint8_t QEIRotatedClockwise = false, QEIRotatedCounterclockwise = false;

	struct Mode
	{
		uint8_t master;
		uint8_t time;
		uint8_t calender;
		uint8_t countdown;
		uint8_t alarm;
		uint8_t doSleep;
		uint8_t doPlayMusic;
	};
	static struct Mode mode = {MASTER_MODE_BOOT, TIME_MODE_DISPLAY, CALENDER_MODE_DISPLAY, COUNTDOWN_MODE_PAUSE, ALARM_MODE_DISPLAY};

	static uint8_t timeSelectedDigit, calenderSelectedDigit, countdownSelectedDigit, alarmSelectedDigit;
	static uint8_t alarmOrdinalNumber;

	//外设输出
	char segmentDisplayCharacter[8];

	//外设输入
	static uint8_t previousKeypadState[8];
	static uint8_t previousButtonState[2];
	uint8_t currentKeypadState[8] = {0};
	uint8_t currentButtonState[2] = {0};
	uint16_t keypadPressed[8] = {0}, keypadHold[8] = {0};
	uint16_t buttonPressed[2] = {0}, buttonHold[2] = {0};
	static uint16_t keypadHoldCount[8] = {0}, buttonHoldCount[8] = {0};

	uint8_t UARTMessageReceived = false;
	char *msg = peripheralDeviceInput.UARTMessage;

	counter++;

	//UART接受数据完整性验证:
	if (peripheralDeviceInput.UARTMessageReceiveFinishedCountdown < 100)
	{
		peripheralDeviceInput.UARTMessageReceiveFinishedCountdown++;
	}
	else if (peripheralDeviceInput.UARTMessageReceiveFinishedCountdown == 100)
	{
		peripheralDeviceInput.UARTMessageReceiveFinishedCountdown = 1926;
		UARTMessageReceived = true;
		peripheralDeviceInput.UARTMessageTail = peripheralDeviceInput.UARTMessage;
	}

	//Keypad及按钮状态.
	if (counter % (SYSTICK_FREQUENCY * 20 / 1000) == 0) //20ms
	{
		for (i = 0; i < 8; i++)
		{
			currentKeypadState[i] = ((~peripheralDeviceInput.keyPadStateByte) >> i) & 1;
			keypadPressed[i] = currentKeypadState[i] && !previousKeypadState[i];
			keypadHoldCount[i] = (currentKeypadState[i] && previousKeypadState[i]) ? keypadHoldCount[i] + 1 : 0;
			keypadHold[i] = keypadHoldCount[i] > 0 && (keypadHoldCount[i] % 50 == 0);
			previousKeypadState[i] = currentKeypadState[i];
		}
		for (i = 0; i < 2; i++)
		{
			currentButtonState[i] = ((~peripheralDeviceInput.buttonStateByte) >> i) & 1;
			buttonPressed[i] = currentButtonState[i] && !previousButtonState[i];
			buttonHoldCount[i] = (currentButtonState[i] && previousButtonState[i]) ? buttonHoldCount[i] + 1 : 0;
			buttonHold[i] = buttonHoldCount[i] > 0 && (buttonHoldCount[i] % 50 == 0);
			previousButtonState[i] = currentButtonState[i];
		}
	}

	if (counter % (SYSTICK_FREQUENCY * 100 / 1000) == 0)
	{
		if ((previousQEIPosition > peripheralDeviceInput.QEIPosition) ? previousQEIPosition - peripheralDeviceInput.QEIPosition >= 2 : peripheralDeviceInput.QEIPosition - previousQEIPosition >= 2)
		{
			previousQEIPosition = peripheralDeviceInput.QEIPosition;
			previousQEIDirection = peripheralDeviceInput.QEIDirection;
			if (peripheralDeviceInput.QEIDirection == 1)
			{
				QEIRotatedClockwise = true;
				QEIRotatedCounterclockwise = false;
			}
			else if (peripheralDeviceInput.QEIDirection == -1)
			{
				QEIRotatedClockwise = false;
				QEIRotatedCounterclockwise = true;
			}
		}
		else
		{
			QEIRotatedClockwise = false;
			QEIRotatedCounterclockwise = false;
		}
	}

	//重启:
	if (buttonHoldCount[0] > 50 && buttonHoldCount[1] > 50)
	{
		EEPROMProgram(&timestampInUTCLowBit, 0x400, sizeof(timestampInUTCLowBit));
		EEPROMProgram(&timestampInUTCHighBit, 0x400 + sizeof(timestampInUTCLowBit), sizeof(timestampInUTCHighBit));
		SysCtlReset();
	}

	//时间控制.
	if (mode.time == TIME_MODE_DISPLAY && counter % (SYSTICK_FREQUENCY * 10 / 1000) == 0) //0.01s
	{
		timestampInUTC++;
		addTenMilliseconds(&time);
		if (time.tenMillisecond == 0)
		{
			peripheralDeviceOutput.motorClockwise = true;
			peripheralDeviceOutput.motorCycle = 10;
		}
	}
	// getTimeFromTimestamp(&time, timestampInUTC, 8);

	//倒计时控制.
	if (mode.countdown == COUNTDOWN_MODE_FORWARD && counter % (SYSTICK_FREQUENCY * 10 / 1000) == 0) //0.01s
	{
		if (countdownTimestamp == 0)
			mode.countdown = COUNTDOWN_MODE_TIMEOUT;
		else
		{
			countdownTimestamp--;
			minusTenMilliseconds(&countdownTime);
		}
	}

	//闹钟控制.
	for (i = 0; i < NUMBER_OF_ALARMS; i++)
	{
		// getTimeFromTimestamp(&alarmTime[i], alarmTimestamp[i], 0);

		if (alarmTime[i].hour == time.hour && alarmTime[i].minute == time.minute && alarmTime[i].second == time.second && mode.master != MASTER_MODE_BOOT)
			mode.alarm = ALARM_MODE_RINGING;
	}
	if (mode.alarm == ALARM_MODE_RINGING && keypadPressed[7])
		mode.alarm = ALARM_MODE_DISPLAY;

	//节气计算
	if (solarTermsCorespondingYear != time.year)
	{
		solarTermsCorespondingYear = time.year;
		updateSolarTermsTimestamp(solarTermsTimestamp, solarTermsCorespondingYear);
		for (i = 0; i < 24; i++)
		{
			getTimeFromTimestamp(&solarTerms[i], solarTermsTimestamp[i], 8);
		}
	}

	//主模式切换.
	if (buttonPressed[0])
		mode.master = (mode.master + NUMBER_OF_MASTER_MODES - 1) % NUMBER_OF_MASTER_MODES;
	if (buttonPressed[1])
		mode.master = (mode.master + 1) % NUMBER_OF_MASTER_MODES;

	if (buttonHold[0])
		peripheralDeviceOutput.lightLevel = (peripheralDeviceOutput.lightLevel + NUMBERS_OF_LIGHT_LEVELS - 1) % NUMBERS_OF_LIGHT_LEVELS;
	if (buttonHold[1])
		peripheralDeviceOutput.lightLevel = (peripheralDeviceOutput.lightLevel + 1) % NUMBERS_OF_LIGHT_LEVELS;
	//输入输出
	if (bootCountdown > 0)
	{
		segmentDisplayCharacter[0] = convertNumberToChar(2);
		segmentDisplayCharacter[1] = convertNumberToChar(1);
		segmentDisplayCharacter[2] = convertNumberToChar(9);
		segmentDisplayCharacter[3] = convertNumberToChar(1);
		segmentDisplayCharacter[4] = convertNumberToChar(0);
		segmentDisplayCharacter[5] = convertNumberToChar(2);
		segmentDisplayCharacter[6] = convertNumberToChar(7);
		segmentDisplayCharacter[7] = convertNumberToChar(9);
		segmentDisplayBlink(segmentDisplayCharacter, counter, 0xff);
		if (counter % (SYSTICK_FREQUENCY * 200 / 1000) == 0)
		{
			peripheralDeviceOutput.LEDDisplayByte = ~peripheralDeviceOutput.LEDDisplayByte;
		}
		bootCountdown--;
	}
	else
	{
		peripheralDeviceOutput.LEDDisplayByte = 0;
		for (i = 0; i < 8; i++)
			segmentDisplayCharacter[i] = ' ';
		switch (mode.master)
		{
		case MASTER_MODE_TIME:
		{
			peripheralDeviceOutput.LEDDisplayByte = 1 << MASTER_MODE_TIME;
			if (keypadPressed[5])
			{
				mode.time = TIME_MODE_SET;
				timeSelectedDigit = 5;
			}
			else if (keypadPressed[7])
				mode.time = TIME_MODE_DISPLAY;
			segmentDisplayCharacter[0] = convertNumberToChar(time.hour / 10);
			segmentDisplayCharacter[1] = convertNumberToChar(time.hour % 10);
			segmentDisplayCharacter[2] = convertNumberToChar(time.minute / 10);
			segmentDisplayCharacter[3] = convertNumberToChar(time.minute % 10);
			segmentDisplayCharacter[4] = convertNumberToChar(time.second / 10);
			segmentDisplayCharacter[5] = convertNumberToChar(time.second % 10);
			segmentDisplayCharacter[6] = convertNumberToChar(time.tenMillisecond % 100 / 10);
			segmentDisplayCharacter[7] = convertNumberToChar(time.tenMillisecond % 10);

			if (mode.time == TIME_MODE_SET)
			{
				if (keypadPressed[0])
					timeSelectedDigit = (timeSelectedDigit + 5) % 6;
				if (keypadPressed[2])
					timeSelectedDigit = (timeSelectedDigit + 1) % 6;
				if (keypadPressed[6] || QEIRotatedClockwise)
				{
					switch (timeSelectedDigit)
					{
					case 0:
						timestampInUTC += 36000 * 100;
						break;
					case 1:
						timestampInUTC += 3600 * 100;
						break;
					case 2:
						timestampInUTC += 600 * 100;
						break;
					case 3:
						timestampInUTC += 60 * 100;
						break;
					case 4:
						timestampInUTC += 10 * 100;
						break;
					case 5:
						timestampInUTC += 1 * 100;
						break;
					default:
						break;
					}
					getTimeFromTimestamp(&time, timestampInUTC, 8);
				}
				if (keypadPressed[1] || QEIRotatedCounterclockwise)
				{
					switch (timeSelectedDigit)
					{
					case 0:
						timestampInUTC -= 36000 * 100;
						break;
					case 1:
						timestampInUTC -= 3600 * 100;
						break;
					case 2:
						timestampInUTC -= 600 * 100;
						break;
					case 3:
						timestampInUTC -= 60 * 100;
						break;
					case 4:
						timestampInUTC -= 10 * 100;
						break;
					case 5:
						timestampInUTC -= 1 * 100;
						break;
					default:
						break;
					}
					getTimeFromTimestamp(&time, timestampInUTC, 8);
				}
				if (counter % (SYSTICK_FREQUENCY * 200 / 1000) < (SYSTICK_FREQUENCY * 200 / 1000) / 2)
					segmentDisplayCharacter[timeSelectedDigit] = ' ';
			}
		}
		break;
		case MASTER_MODE_CALENDER:
		{
			peripheralDeviceOutput.LEDDisplayByte = 1 << MASTER_MODE_CALENDER;
			if (keypadPressed[5])
			{
				mode.calender = CALENDER_MODE_SET;
				calenderSelectedDigit = 7;
			}
			else if (keypadPressed[7])
				mode.calender = CALENDER_MODE_DISPLAY;
			segmentDisplayCharacter[0] = convertNumberToChar(time.year % 10000 / 1000);
			segmentDisplayCharacter[1] = convertNumberToChar(time.year % 1000 / 100);
			segmentDisplayCharacter[2] = convertNumberToChar(time.year % 100 / 10);
			segmentDisplayCharacter[3] = convertNumberToChar(time.year % 10);
			segmentDisplayCharacter[4] = convertNumberToChar((time.month + 1) % 100 / 10);
			segmentDisplayCharacter[5] = convertNumberToChar((time.month + 1) % 10);
			segmentDisplayCharacter[6] = convertNumberToChar((time.day + 1) % 100 / 10);
			segmentDisplayCharacter[7] = convertNumberToChar((time.day + 1) % 10);

			if (mode.calender == CALENDER_MODE_SET)
			{
				if (keypadPressed[0])
					do
					{
						calenderSelectedDigit = (calenderSelectedDigit + 7) % 8;
					} while (!(calenderSelectedDigit == 3 || calenderSelectedDigit == 5 || calenderSelectedDigit == 6 || calenderSelectedDigit == 7));
				if (keypadPressed[2])
					do
					{
						calenderSelectedDigit = (calenderSelectedDigit + 1) % 8;
					} while (!(calenderSelectedDigit == 3 || calenderSelectedDigit == 5 || calenderSelectedDigit == 6 || calenderSelectedDigit == 7));
				if (keypadPressed[6] || QEIRotatedClockwise)
				{
					switch (calenderSelectedDigit)
					{
					case 0:
						break;
					case 1:
						break;
					case 2:
						break;
					case 3:
						timestampInUTC += (uint32_t)(((time.month <= 2 && isLeapYear(time.year)) || (time.month > 2 && isLeapYear(time.year + 1))) ? daysInLeapYear : daysInYear) * 86400 * 100;
						break;
					case 4:
						break;
					case 5:
						timestampInUTC += (isLeapYear(time.year) ? daysInMonthInLeapYear[time.month] : daysInMonth[time.month]) * 86400 * 100;
						break;
					case 6:
						timestampInUTC += 10 * 86400 * 100;
						break;
					case 7:
						timestampInUTC += 1 * 86400 * 100;
						break;
					default:
						break;
					}
					getTimeFromTimestamp(&time, timestampInUTC, 8);
				}
				if (keypadPressed[1] || QEIRotatedCounterclockwise)
				{
					switch (calenderSelectedDigit)
					{
					case 0:
						break;
					case 1:
						break;
					case 2:
						break;
					case 3:
						timestampInUTC -= (uint32_t)(((time.month <= 2 && isLeapYear(time.year)) || (time.month > 2 && isLeapYear(time.year + 1))) ? daysInLeapYear : daysInYear) * 86400 * 100;
						break;
					case 4:
						break;
					case 5:
						timestampInUTC -= (isLeapYear(time.year) ? daysInMonthInLeapYear[(time.month + 11) % 12] : daysInMonth[(time.month + 11) % 12]) * 86400 * 100;
						break;
					case 6:
						timestampInUTC -= 10 * 86400 * 100;
						break;
					case 7:
						timestampInUTC -= 1 * 86400 * 100;
						break;
					default:
						break;
					}
					getTimeFromTimestamp(&time, timestampInUTC, 8);
				}
				if (counter % (SYSTICK_FREQUENCY * 200 / 1000) < (SYSTICK_FREQUENCY * 200 / 1000) / 2)
					segmentDisplayCharacter[calenderSelectedDigit] = ' ';
			}
		}
		break;
		case MASTER_MODE_SOLAR_TERMS:
		{
			peripheralDeviceOutput.LEDDisplayByte = 1 << MASTER_MODE_SOLAR_TERMS;
			segmentDisplayCharacter[0] = convertNumberToChar(time.year % 10000 / 1000);
			segmentDisplayCharacter[1] = convertNumberToChar(time.year % 1000 / 100);
			segmentDisplayCharacter[2] = convertNumberToChar(time.year % 100 / 10);
			segmentDisplayCharacter[3] = convertNumberToChar(time.year % 10);
			for (i = 0; i < 24; i++)
			{
				if (solarTerms[i].month == time.month && solarTerms[i].day == time.day)
				{
					segmentDisplayCharacter[4] = 'S';
					segmentDisplayCharacter[5] = 'P';
					segmentDisplayCharacter[6] = convertNumberToChar(((i + 24 - 2) % 24 + 1) / 10);
					segmentDisplayCharacter[7] = convertNumberToChar(((i + 24 - 2) % 24 + 1) % 10);
					break;
				}
			}
		}
		break;
		case MASTER_MODE_COUNTDOWN:
		{
			peripheralDeviceOutput.LEDDisplayByte = 1 << MASTER_MODE_COUNTDOWN;
			if (keypadPressed[5])
				mode.countdown = (mode.countdown == COUNTDOWN_MODE_SET) ? COUNTDOWN_MODE_PAUSE : COUNTDOWN_MODE_SET;
			else if (keypadPressed[7])
				mode.countdown = (mode.countdown == COUNTDOWN_MODE_PAUSE) ? COUNTDOWN_MODE_FORWARD : COUNTDOWN_MODE_PAUSE;

			segmentDisplayCharacter[0] = convertNumberToChar(countdownTime.hour / 10);
			segmentDisplayCharacter[1] = convertNumberToChar(countdownTime.hour % 10);
			segmentDisplayCharacter[2] = convertNumberToChar(countdownTime.minute / 10);
			segmentDisplayCharacter[3] = convertNumberToChar(countdownTime.minute % 10);
			segmentDisplayCharacter[4] = convertNumberToChar(countdownTime.second / 10);
			segmentDisplayCharacter[5] = convertNumberToChar(countdownTime.second % 10);
			segmentDisplayCharacter[6] = convertNumberToChar(countdownTime.tenMillisecond % 100 / 10);
			segmentDisplayCharacter[7] = convertNumberToChar(countdownTime.tenMillisecond % 10);

			if (mode.countdown == COUNTDOWN_MODE_TIMEOUT && counter % (SYSTICK_FREQUENCY * 200 / 1000) < (SYSTICK_FREQUENCY * 200 / 1000) / 2)
			{
				for (i = 0; i < 8; i++)
					segmentDisplayCharacter[i] = ' ';
			}

			if (mode.countdown == COUNTDOWN_MODE_SET)
			{
				if (keypadPressed[0])
					countdownSelectedDigit = (countdownSelectedDigit + 5) % 6;
				if (keypadPressed[2])
					countdownSelectedDigit = (countdownSelectedDigit + 1) % 6;

				if (keypadPressed[6] || QEIRotatedClockwise)
				{
					switch (countdownSelectedDigit)
					{
					case 0:
						countdownTimestamp += 36000 * 100;
						break;
					case 1:
						countdownTimestamp += 3600 * 100;
						break;
					case 2:
						countdownTimestamp += 600 * 100;
						break;
					case 3:
						countdownTimestamp += 60 * 100;
						break;
					case 4:
						countdownTimestamp += 10 * 100;
						break;
					case 5:
						countdownTimestamp += 1 * 100;
						break;
					default:
						break;
					}
					countdownTimestamp %= 86400 * 100;
					getTimeFromTimestamp(&countdownTime, countdownTimestamp, 0);
				}
				if (keypadPressed[1] || QEIRotatedCounterclockwise)
				{
					countdownTimestamp += 86400 * 100;
					switch (countdownSelectedDigit)
					{
					case 0:
						countdownTimestamp -= 36000 * 100;
						break;
					case 1:
						countdownTimestamp -= 3600 * 100;
						break;
					case 2:
						countdownTimestamp -= 600 * 100;
						break;
					case 3:
						countdownTimestamp -= 60 * 100;
						break;
					case 4:
						countdownTimestamp -= 10 * 100;
						break;
					case 5:
						countdownTimestamp -= 1 * 100;
						break;
					default:
						break;
					}
					countdownTimestamp %= 86400 * 100;
					getTimeFromTimestamp(&countdownTime, countdownTimestamp, 0);
				}

				segmentDisplayBlink(segmentDisplayCharacter, counter, 1 << countdownSelectedDigit);
			}
		}
		break;
		case MASTER_MODE_ALARM:
		{
			peripheralDeviceOutput.LEDDisplayByte = 1 << MASTER_MODE_ALARM;
			if (keypadPressed[4])
				alarmOrdinalNumber = (alarmOrdinalNumber + 1) % NUMBER_OF_ALARMS;
			if (keypadPressed[3])
				alarmOrdinalNumber = (alarmOrdinalNumber + NUMBER_OF_ALARMS - 1) % NUMBER_OF_ALARMS;

			if (keypadPressed[5])
			{
				mode.alarm = ALARM_MODE_SET;
				alarmSelectedDigit = 7;
			}
			else if (keypadPressed[7])
				mode.alarm = ALARM_MODE_DISPLAY;
			segmentDisplayCharacter[0] = convertNumberToChar(alarmOrdinalNumber);
			segmentDisplayCharacter[1] = ' ';
			segmentDisplayCharacter[2] = convertNumberToChar(alarmTime[alarmOrdinalNumber].hour / 10);
			segmentDisplayCharacter[3] = convertNumberToChar(alarmTime[alarmOrdinalNumber].hour % 10);
			segmentDisplayCharacter[4] = convertNumberToChar(alarmTime[alarmOrdinalNumber].minute / 10);
			segmentDisplayCharacter[5] = convertNumberToChar(alarmTime[alarmOrdinalNumber].minute % 10);
			segmentDisplayCharacter[6] = convertNumberToChar(alarmTime[alarmOrdinalNumber].second / 10);
			segmentDisplayCharacter[7] = convertNumberToChar(alarmTime[alarmOrdinalNumber].second % 10);

			if (mode.alarm == ALARM_MODE_SET)
			{
				if (keypadPressed[0])
					alarmSelectedDigit = (alarmSelectedDigit - 2 + 5) % 6 + 2;
				if (keypadPressed[2])
					alarmSelectedDigit = (alarmSelectedDigit - 2 + 1) % 6 + 2;

				if (keypadPressed[6] || QEIRotatedClockwise)
				{
					switch (alarmSelectedDigit)
					{
					case 2:
						alarmTimestamp[alarmOrdinalNumber] += 36000 * 100;
						break;
					case 3:
						alarmTimestamp[alarmOrdinalNumber] += 3600 * 100;
						break;
					case 4:
						alarmTimestamp[alarmOrdinalNumber] += 600 * 100;
						break;
					case 5:
						alarmTimestamp[alarmOrdinalNumber] += 60 * 100;
						break;
					case 6:
						alarmTimestamp[alarmOrdinalNumber] += 10 * 100;
						break;
					case 7:
						alarmTimestamp[alarmOrdinalNumber] += 1 * 100;
						break;
					default:
						break;
					}
					alarmTimestamp[alarmOrdinalNumber] %= 86400 * 100;
					getTimeFromTimestamp(&alarmTime[alarmOrdinalNumber], alarmTimestamp[alarmOrdinalNumber], 0);
				}
				if (keypadPressed[1] || QEIRotatedCounterclockwise)
				{
					alarmTimestamp[alarmOrdinalNumber] += 86400 * 100;
					switch (alarmSelectedDigit)
					{
					case 2:
						alarmTimestamp[alarmOrdinalNumber] -= 36000 * 100;
						break;
					case 3:
						alarmTimestamp[alarmOrdinalNumber] -= 3600 * 100;
						break;
					case 4:
						alarmTimestamp[alarmOrdinalNumber] -= 600 * 100;
						break;
					case 5:
						alarmTimestamp[alarmOrdinalNumber] -= 60 * 100;
						break;
					case 6:
						alarmTimestamp[alarmOrdinalNumber] -= 10 * 100;
						break;
					case 7:
						alarmTimestamp[alarmOrdinalNumber] -= 1 * 100;
						break;
					default:
						break;
					}
					alarmTimestamp[alarmOrdinalNumber] %= 86400 * 100;
					getTimeFromTimestamp(&alarmTime[alarmOrdinalNumber], alarmTimestamp[alarmOrdinalNumber], 0);
				}

				segmentDisplayBlink(segmentDisplayCharacter, counter, 1 << alarmSelectedDigit);
			}
			if (mode.alarm == ALARM_MODE_RINGING)
			{
				segmentDisplayBlink(segmentDisplayCharacter, counter, 0xff);
			}
		}
		break;
		case MASTER_MODE_BOOT:
		{
			mode.master = MASTER_MODE_TIME;
			EEPROMRead(&timestampInUTCLowBit, 0x400, sizeof(timestampInUTCLowBit));
			EEPROMRead(&timestampInUTCHighBit, 0x400 + sizeof(timestampInUTCLowBit), sizeof(timestampInUTCHighBit));
			timestampInUTC = (uint64_t)timestampInUTCLowBit + (((uint64_t)timestampInUTCHighBit) << 32);
			getTimeFromTimestamp(&time, timestampInUTC, 8);
			getTimeFromTimestamp(&countdownTime, countdownTimestamp, 0);
			for (i = 0; i < NUMBER_OF_ALARMS; i++)
				getTimeFromTimestamp(&alarmTime[i], alarmTimestamp[i], 0);
			bootCountdown = SYSTICK_FREQUENCY * 6;
		}
		break;
		default:
			break;
		}
	}
	for (i = 0; i < 8; i++)
	{
		peripheralDeviceOutput.segmentDisplayControlWord[i] = getSegmentDisplayControlWord(segmentDisplayCharacter[i]);
		segmentDisplayCharacter[i] = ' ';
	}

	if (mode.alarm == ALARM_MODE_RINGING)
		peripheralDeviceOutput.beepFrequency = 2000;
	else if (mode.doPlayMusic)
	{

		// if (counter % (SYSTICK_FREQUENCY * 1 / 1000) == 0) // 1ms
		noteTime++;

		if (notes[noteIndex].chord[0] == 0 && notes[noteIndex].time == 0)
		{
			noteTime = 0;
			noteIndex = 0;
		}
		while (noteTime >= notes[noteIndex + 1].time)
		{
			noteIndex++;
			chordInterleavingSelection = 0;
		}
		// Interleave chords
		if (counter % (SYSTICK_FREQUENCY * 5 / 1000) == 0) // 5ms
			chordInterleavingSelection = (chordInterleavingSelection + 1) % notes[noteIndex].chordSize;
		peripheralDeviceOutput.beepFrequency = noteFrequency[notes[noteIndex].chord[chordInterleavingSelection]];
	}
	else
		peripheralDeviceOutput.beepFrequency = 0;

	if (UARTMessageReceived)
	{
		if (strncasecmp(msg, "set", strlen("set")) == 0)
		{
			if (strncasecmp(msg + strlen("set") + 1, "timestamp", strlen("timestamp")) == 0)
			{
				uint64_t timestampFromMessage = readNumberFromString(msg + strlen("set timestamp "), '\0');

				char tmp[100];
				sprintf(tmp, "Updating current timestamp to:%llu(times ten milliseconds)", timestampFromMessage);
				UARTStringPut(tmp);

				timestampInUTC = timestampFromMessage;
				getTimeFromTimestamp(&time, timestampInUTC, 8);
			}
			else if (strncasecmp(msg + strlen("set") + 1, "clock", strlen("clock")) == 0)
			{

				char tmp[100];

				char *firstColon = strpbrk(msg + strlen("set clock "), ":");
				char *secondColon = strpbrk(firstColon + 1, ":");

				if (*firstColon != ':' || *secondColon != ':')
				{
					sprintf(tmp, "Error!");
					UARTStringPut(tmp);
				}
				else
				{
					uint64_t hour = readNumberFromString(msg + strlen("set clock "), ':'),
							 minute = readNumberFromString(firstColon + 1, ':'),
							 second = readNumberFromString(secondColon + 1, '\0');
					if (hour >= 24 || minute >= 60 || second >= 60)
					{
						sprintf(tmp, "Error!");
						UARTStringPut(tmp);
					}
					else
					{
						
						time.hour = hour;
						time.minute = minute;
						time.second = second;
						timestampInUTC = getTimestampFromTime(&time, 8);
						sprintf(tmp, "Updating current clock to:%llu:%llu:%llu", hour, minute, second);
						UARTStringPut(tmp);
					}
				}
			}
			else if (strncasecmp(msg + strlen("set") + 1, "calender", strlen("calender")) == 0)
			{

				char tmp[100];

				char *firstSpacebar = strpbrk(msg + strlen("set calender "), " ");
				char *secondSpacebar = strpbrk(firstSpacebar + 1, " ");

				if (*firstSpacebar != ' ' || *secondSpacebar != ' ')
				{
					sprintf(tmp, "Error!");
					UARTStringPut(tmp);
				}
				else
				{
					uint64_t year = readNumberFromString(msg + strlen("set calender "), ' '),
							 month = readNumberFromString(firstSpacebar + 1, ' ') - 1,
							 day = readNumberFromString(secondSpacebar + 1, '\0') - 1;
					if (year < 1970 || month >= 12 || day >= (isLeapYear(year) ? daysInMonthInLeapYear[month] : daysInMonth[month]))
					{
						sprintf(tmp, "Error!");
						UARTStringPut(tmp);
					}
					else
					{
						sprintf(tmp, "Updating current calender to:%llu-%llu-%llu", year, month + 1, day + 1);
						UARTStringPut(tmp);
						time.year = year;
						time.month = month;
						time.day = day;
						timestampInUTC = getTimestampFromTime(&time, 8);
					}
				}
			}
			else if (strncasecmp(msg + strlen("set") + 1, "countdown", strlen("countdown")) == 0)
			{

				char tmp[100];

				char *firstColon = strpbrk(msg + strlen("set countdown "), ":");
				char *secondColon = strpbrk(firstColon + 1, ":");

				if (*firstColon != ':' || *secondColon != ':')
				{
					sprintf(tmp, "Error!");
					UARTStringPut(tmp);
				}
				else
				{
					uint64_t hour = readNumberFromString(msg + strlen("set countdown "), ':'),
							 minute = readNumberFromString(firstColon + 1, ':'),
							 second = readNumberFromString(secondColon + 1, '\0');
					if (hour >= 24 || minute >= 60 || second >= 60)
					{
						sprintf(tmp, "Error!");
						UARTStringPut(tmp);
					}
					else
					{
						sprintf(tmp, "Updating current countdown to:%llu:%llu:%llu", hour, minute, second);
						UARTStringPut(tmp);
						countdownTime.hour = hour;
						countdownTime.minute = minute;
						countdownTime.second = second;
						countdownTimestamp = getTimestampFromTime(&countdownTime, 0);
					}
				}
			}
			else if (strncasecmp(msg + strlen("set") + 1, "alarm", strlen("alarm")) == 0)
			{

				char tmp[100];

				char *firstSpacebar = strpbrk(msg + strlen("set alarm"), " ");
				char *secondSpacebar = strpbrk(firstSpacebar + 1, " ");
				char *firstColon = strpbrk(secondSpacebar + 1, ":");
				char *secondColon = strpbrk(firstColon + 1, ":");

				if (*firstSpacebar != ' ' || *firstColon != ':' || *secondColon != ':')
				{
					sprintf(tmp, "Error!");
					UARTStringPut(tmp);
				}
				else
				{
					uint64_t alarmOrdinalNumberFromMessage = readNumberFromString(firstSpacebar + 1, ' '),
							 hour = readNumberFromString(secondSpacebar + 1, ':'),
							 minute = readNumberFromString(firstColon + 1, ':'),
							 second = readNumberFromString(secondColon + 1, '\0');
					if (hour >= 24 || minute >= 60 || second >= 60 || alarmOrdinalNumberFromMessage > NUMBER_OF_ALARMS - 1)
					{
						sprintf(tmp, "Error!");
						UARTStringPut(tmp);
					}
					else
					{
						sprintf(tmp, "Updating alarm %llu to:%llu:%llu:%llu", alarmOrdinalNumberFromMessage, hour, minute, second);
						UARTStringPut(tmp);
						alarmTime[alarmOrdinalNumberFromMessage].hour = hour;
						alarmTime[alarmOrdinalNumberFromMessage].minute = minute;
						alarmTime[alarmOrdinalNumberFromMessage].second = second;
						alarmTimestamp[alarmOrdinalNumberFromMessage] = getTimestampFromTime(&alarmTime[alarmOrdinalNumberFromMessage], 0);
					}
				}
			}
			else
				UARTStringPut("Error!");
		}
		else if (strncmp(msg, "MUSIC", strlen("MUSIC")) == 0)
		{
			if (strncmp(msg + strlen("MUSIC") + 1, "PLAY", strlen("PLAY")) == 0)
			{
				noteTime = 0;
				noteIndex = 0;
				mode.doPlayMusic = true;
				char tmp[100];
				sprintf(tmp, "To NZ");
				UARTStringPut(tmp);
			}
			else if (strncmp(msg + strlen("MUSIC") + 1, "STOP", strlen("STOP")) == 0)
			{

				mode.doPlayMusic = false;
				noteTime = 0;
				peripheralDeviceOutput.beepFrequency = 0;
			}
			else
				UARTStringPut("Error!");
		}
		else
			UARTStringPut("Error!");
	}
}
void UART0_Handler(void)
{

	uint32_t ulStatus;
	ulStatus = UARTIntStatus(UART0_BASE, true);
	UARTIntClear(UART0_BASE, ulStatus);

	while (UARTCharsAvail(UART0_BASE))
	{
		*(peripheralDeviceInput.UARTMessageTail++) = UARTCharGetNonBlocking(UART0_BASE);
	}
	*(peripheralDeviceInput.UARTMessageTail) = '\0';
	peripheralDeviceInput.UARTMessageReceiveFinishedCountdown = 0;
}
uint8_t I2C0_WriteByte(uint8_t DevAddr, uint8_t RegAddr, uint8_t WriteData)
{
	uint8_t rop;
	while (I2CMasterBusy(I2C0_BASE))
	{
	};	//如果I2C0模块忙，等待
		//
	I2CMasterSlaveAddrSet(I2C0_BASE, DevAddr, false);
	//设置主机要放到总线上的从机地址。false表示主机写从机，true表示主机读从机

	I2CMasterDataPut(I2C0_BASE, RegAddr);						  //主机写设备寄存器地址
	I2CMasterControl(I2C0_BASE, I2C_MASTER_CMD_BURST_SEND_START); //执行重复写入操作
	while (I2CMasterBusy(I2C0_BASE))
	{
	};

	rop = (uint8_t)I2CMasterErr(I2C0_BASE); //调试用

	I2CMasterDataPut(I2C0_BASE, WriteData);
	I2CMasterControl(I2C0_BASE, I2C_MASTER_CMD_BURST_SEND_FINISH); //执行重复写入操作并结束
	while (I2CMasterBusy(I2C0_BASE))
	{
	};

	rop = (uint8_t)I2CMasterErr(I2C0_BASE); //调试用

	return rop; //返回错误类型，无错返回0
}
uint8_t I2C0_ReadByte(uint8_t DevAddr, uint8_t RegAddr)
{
	uint8_t value, rop;
	while (I2CMasterBusy(I2C0_BASE))
	{
	};
	I2CMasterSlaveAddrSet(I2C0_BASE, DevAddr, false);
	I2CMasterDataPut(I2C0_BASE, RegAddr);
	//	I2CMasterControl(I2C0_BASE, I2C_MASTER_CMD_BURST_SEND_START);
	I2CMasterControl(I2C0_BASE, I2C_MASTER_CMD_SINGLE_SEND); //执行单词写入操作
	while (I2CMasterBusBusy(I2C0_BASE))
		;
	rop = (uint8_t)I2CMasterErr(I2C0_BASE);
	Delay(1);
	//receive data
	I2CMasterSlaveAddrSet(I2C0_BASE, DevAddr, true);			//设置从机地址
	I2CMasterControl(I2C0_BASE, I2C_MASTER_CMD_SINGLE_RECEIVE); //执行单次读操作
	while (I2CMasterBusBusy(I2C0_BASE))
		;
	value = I2CMasterDataGet(I2C0_BASE); //获取读取的数据
	Delay(1);
	return value;
}

bool isLeapYear(uint16_t year)
{
	return year % 4 == 0 && (!(year % 100 == 0) || year % 400 == 0);
}
char convertNumberToChar(uint8_t number)
{
	if (number >= 0 && number <= 9)
		return number + '0';
	else
		return number + 'a';
}
uint8_t getSegmentDisplayControlWord(char character)
{
	char const characterSet[] = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'b', 'B', 'C', 'd', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'o', 'O', 'Q', 'R', 'T', 'S', 'U', 'V', 'W', 'X', 'Y', 'Z', '.', '-', '_', ' ', '\0'};
	uint8_t const controlWordSet[] = {0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x6F, 0x77, 0x7C, 0x7c, 0x39, 0x5E, 0x5e, 0x79, 0x71, 0x3d, 0x76, 0x0d, 0x72, 0x38, 0x55, 0x54, 0x73, 0x5c, 0x5c, 0x6f, 0x50, 0x78, 0x6d, 0x3e, 0x1c, 0x6a, 0x1d, 0x6e, 0x49, 0x80, 0x40, 0x08, 0x00};
	char *characterPosition = strchr(characterSet, character);
	return (characterPosition != NULL ? *(controlWordSet + (characterPosition - characterSet)) : 0x0);
}
void getTimeFromTimestamp(struct Time *time, uint64_t timestamp, uint32_t timeZone)
{
	// if (timestamp >= (uint64_t)142004160000)
	// {
	// 	timestamp = timestamp - (uint64_t)142004160000;
	// 	time->year = 2015;
	// }
	// else

	time->year = 1970;
	time->tenMillisecond = timestamp % 100;
	time->second = timestamp / 100 % 60;
	time->minute = timestamp / 100 % 3600 / 60;
	time->hour = timestamp / 100 % 86400 / 3600 + timeZone;

	time->day = timestamp / 100 / 86400;
	if (time->hour >= 24)
	{
		time->hour -= 24;
		time->day++;
	}

	time->month = 0;

	while (time->day >= (isLeapYear(time->year) ? daysInLeapYear : daysInYear))
	{
		time->day -= (isLeapYear(time->year) ? daysInLeapYear : daysInYear);
		time->year++;
	}
	while (time->day >= (isLeapYear(time->year) ? daysInMonthInLeapYear[time->month] : daysInMonth[time->month]))
	{
		time->day -= (isLeapYear(time->year) ? daysInMonthInLeapYear[time->month] : daysInMonth[time->month]);
		time->month++;
	}
}
void addTenMilliseconds(struct Time *time)
{

	time->tenMillisecond++;
	if (time->tenMillisecond >= 100)
	{
		time->tenMillisecond -= 100;
		time->second++;
		if (time->second >= 60)
		{
			time->second -= 60;
			time->minute++;
			if (time->minute >= 60)
			{
				time->minute -= 60;
				time->hour++;
				if (time->hour >= 24)
				{
					time->hour -= 24;
					time->day++;
					if (time->day >= (isLeapYear(time->year) ? daysInLeapYear : daysInYear))
					{
						time->day -= (isLeapYear(time->year) ? daysInLeapYear : daysInYear);
						time->year++;
						if (time->day >= (isLeapYear(time->year) ? daysInMonthInLeapYear[time->month] : daysInMonth[time->month]))
						{
							time->day -= (isLeapYear(time->year) ? daysInMonthInLeapYear[time->month] : daysInMonth[time->month]);
							time->month++;
						}
					}
				}
			}
		}
	}
}
void minusTenMilliseconds(struct Time *time)
{
	if (time->tenMillisecond == 0)
	{
		time->tenMillisecond = 99;
		if (time->second == 0)
		{
			time->second = 59;
			if (time->minute == 0)
			{
				time->minute = 59;
				if (time->hour == 0)
				{
					time->hour = 23;
					if (time->day == 0)
					{
						if (time->month == 0)
						{
							if (time->year == 0)
								return;
							time->year--;
							time->month = 11;
						}
						else
						{
							time->month--;
						}
						time->day = (isLeapYear(time->year) ? daysInMonthInLeapYear[time->month] : daysInMonth[time->month]) - 1;
					}
					else
						time->day--;
				}
				else
					time->hour--;
			}
			else
				time->minute--;
		}
		else
			time->second--;
	}
	else
		time->tenMillisecond--;
}
void updateSolarTermsTimestamp(uint64_t solarTermsTimestamp[], uint16_t year)
{
	uint16_t i;
	for (i = 0; i < 24; i++)
	{
		solarTermsTimestamp[i] = solarTermsTimestampIn2021[i];
	}
	if (year < 2021)
	{
		while ((year++) != 2021)
		{
			for (i = 0; i < 24; i++)
			{
				solarTermsTimestamp[i] = solarTermsTimestamp[i] - (uint64_t)SECONDS_IN_TROPICAL_YEAR * 100;
			}
		}
	}
	else if (year > 2021)
	{
		while ((year--) != 2021)
		{
			for (i = 0; i < 24; i++)
			{
				solarTermsTimestamp[i] = solarTermsTimestamp[i] + (uint64_t)SECONDS_IN_TROPICAL_YEAR * 100;
			}
		}
	}
}
void segmentDisplayBlink(char *segmentDisplayCharacter, uint64_t counter, uint8_t blinkDigitByte)
{
	uint8_t i;
	if (counter % (SYSTICK_FREQUENCY * 200 / 1000) < (SYSTICK_FREQUENCY * 200 / 1000) / 2)
	{
		for (i = 0; i < 8; i++)
			if (blinkDigitByte & 1 << i)
				segmentDisplayCharacter[i] = ' ';
	}
}
uint64_t getTimestampFromTime(struct Time *time, uint32_t timeZone)
{
	uint64_t timestamp = (uint64_t)time->hour * 3600 * 100 + (uint64_t)time->minute * 60 * 100 + (uint64_t)time->second * 100 + (uint64_t)time->tenMillisecond + (uint64_t)time->day * 86400 * 100 - (uint64_t)timeZone * 3600 * 100;
	uint16_t month = 0, year = 1970;
	while (year < time->year)

	{
		timestamp += isLeapYear(year) ? (uint64_t)daysInLeapYear * 86400 * 100 : (uint64_t)daysInYear * 86400 * 100;
		year++;
	}
	while (month < time->month)
	{
		timestamp += isLeapYear(time->year) ? (uint64_t)daysInMonth[month] * 86400 * 100 : (uint64_t)daysInMonthInLeapYear[month] * 86400 * 100;
		month++;
	}
	return timestamp;
}
uint64_t readNumberFromString(char *string, char delimiter)
{
	uint16_t positionInMessage = 0;
	uint64_t number = 0;
	while (string[positionInMessage] != '\0' && string[positionInMessage] != delimiter)
	{
		number = number * (uint64_t)10 + (uint64_t)(string[positionInMessage++] - '0');
	}
	return number;
}